<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a 
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        default-menu-include="false">

    <transition name="editInvoice"><default-response url="../../Invoice/EditInvoice"/></transition>
    <transition name="editPayment"><default-response url="../../Payment/EditPayment"/></transition>
    <transition name="editTransaction"><default-response url="../../Transaction/EditTransaction"/></transition>
    <transition name="editParty"><default-response url="//${appRoot}/Party/EditParty"/></transition>
    <transition name="editShipment"><default-response url="//${appRoot}/Shipment/EditShipment"/></transition>
    <transition name="assetDetail"><default-response url="//${appRoot}/Asset/AssetDetail"/></transition>

    <transition-include name="searchPartyList" location="component://SimpleScreens/template/party/PartyForms.xml"/>

    <actions>
        <set field="invoiceType" from="invoiceType ?: 'Receivable'"/>
        <set field="statusId" from="statusId ?: (invoiceType == 'Payable' ? 'InvoiceReceived,InvoiceApproved,InvoicePmtSent' : 'InvoiceFinalized,InvoiceSent,InvoicePmtRecvd')"/>
        <set field="statusId_op" value="in"/>

        <if condition="!masterDate_period">
            <set field="masterDate_period" value="month"/>
            <set field="masterDate_poffset" value="0"/>
            <set field="masterDate_pdate" from="ec.l10n.format(ec.user.nowTimestamp, 'yyyy-MM-dd')"/>
        </if>
        <set field="rangeList" from="ec.user.getPeriodRange(masterDate_period, masterDate_poffset, masterDate_pdate)"/>
        <set field="fromDate" from="rangeList[0]"/>
        <set field="thruDate" from="rangeList[1]"/>

        <set field="itemDate_period" from="masterDate_period"/><set field="itemDate_poffset" from="masterDate_poffset"/>
        <set field="itemDate_pdate" from="masterDate_pdate"/>
        <set field="appliedDate_period" from="masterDate_period"/><set field="appliedDate_poffset" from="masterDate_poffset"/>
        <set field="appliedDate_pdate" from="masterDate_pdate"/>

        <entity-find entity-name="moqui.basic.EnumGroupMember" list="txTypeMemberList">
            <econdition field-name="enumGroupEnumId" value="EngAccTxTypesInvoice"/></entity-find>
        <set field="txTypeEnumIdList" from="txTypeMemberList*.enumId"/>
    </actions>
    <widgets>
        <!--
        NOTE: this section would be more useful if it operated very differently to reconcile Invoice and PaymentApplication against AcctgTrans/Entry

        Business goals, comments:
        - Explain differences between invoice aging reports and Balance Sheet
        - View negative transaction entries for invoices
          - There is a valid case for these transactions in Mantle, ie invoice adjustments such early payment and other discounts applied
            at the time of payment so not in the original transaction for the invoice
          - Not sure why this needs to be checked, should result in valid totals in the Balance Sheet and Income Statement, ie at the
            time of payment the AR/AP accounts would be fully adjusted for the settled invoice
          - The code for the reconcile report flags these as 'suspicious' but I don't see that displayed anywhere, so maybe this is ignored anyway
        - View payment application transactions for invoices that are not posted within the period
          - This shouldn't ever happen, ie a payment applied to an invoice before the invoice is posted
          - Mantle does not allow this, just like it doesn't allow applying a Payment that is not yet received or sent
          - Would result in an incorrect value in AR/AP accounts (reducing payable/receivable total for other invoices posted)
          - Payment should remain unapplied so it shows in Unearned Revenue for receivable or Prepaid Expense for payable
            instead of mucking up the AR/AP amount
            (ie for receivable moving the amount from Liability (Unearned Revenue) to negative amount in Asset (Accounts Receivable)
        - View invoice transaction total and/or payment application transaction total for invoices where they are not equal with the time period
          - The approach in Mantle is to handle receivable unapplied payments to Unearned Revenue (Liability) and payable unapplied payments to Prepaid Expense (Asset)
          - The concept of an unapplied payment is still important as this is how these accounts (Unearned Revenue, Prepaid Expense) are maintained
        - View unposted transactions
          - Automatic unposted transactions are added to the error journal
          - The period close finalize checks to make sure all transactions in the period are posted
        - View transactions posted to a payable or receivable account with no invoiceId
          - There seem to be valid reasons for these such as manual adjustments
          - Does this really need to be checked? What scenario would result in an invalid transaction or balance sheet issue?
        - View payment application transactions where invoice date on related invoice is after the period
          - See notes about about payment application transactions for invoices not yet posted

        -->
        <container-box><box-header title="Invoice Payment Reconciliation"/><box-body-nopad>
            <form-list name="InvoiceAndPaymentApplicationList" list="invoiceList" skip-form="true" header-dialog="true" select-columns="true"
                    saved-finds="true" show-csv-button="true" show-all-button="true">
                <!-- NOTE: depends on itemDate defaulting to invoiceDate, or rather itemDate on all InvoiceItem so that diff for date range is correct -->
                <entity-find entity-name="mantle.account.invoice.InvoicePaymentApplicationSummary" list="invoiceAgingList">
                    <search-form-inputs default-order-by="invoiceDate,appliedDate,invoiceId,paymentId"/>
                    <econditions combine="or">
                        <econdition field-name="itemsTotal" operator="not-equals" from="0.0"/>
                        <econdition field-name="amountApplied" operator="not-equals" from="0.0"/>
                    </econditions>
                    <econditions combine="or">
                        <econdition field-name="itemsTotal" operator="not-equals" to-field-name="amountApplied"/>
                        <econdition field-name="itemsTotal" operator="is-null"/>
                        <econdition field-name="amountApplied" operator="is-null"/>
                    </econditions>
                    <select-field field-name="invoiceId,invoiceDate,itemsTotal,amountApplied"/>
                </entity-find>

                <field name="invoiceType"><header-field title="AR/AP"><drop-down><option key="Receivable" text="Receivable"/>
                    <option key="Payable" text="Payable"/></drop-down></header-field></field>
                <field name="masterDate"><header-field title="Date Range"><date-period/></header-field></field>

                <field name="invoiceId" aggregate="group-by"><header-field show-order-by="true" title="Invoice"/>
                    <default-field><link url="editInvoice" text="${invoiceId}" link-type="anchor"/></default-field></field>
                <field name="invoiceDate"><header-field show-order-by="true"/>
                    <default-field><display format="yyyy-MM-dd"/></default-field></field>

                <field name="fromPartyId">
                    <header-field title="From"><drop-down allow-empty="true">
                        <dynamic-options transition="searchPartyList" server-search="true" min-length="2"/></drop-down></header-field>
                    <default-field><link url="editParty" entity-name="mantle.party.PartyDetail" text="${pseudoId}"
                            link-type="anchor" parameter-map="[partyId:fromPartyId]"/></default-field>
                </field>
                <field name="toPartyId">
                    <header-field title="To"><drop-down allow-empty="true">
                        <dynamic-options transition="searchPartyList" server-search="true" min-length="2"/></drop-down></header-field>
                    <default-field><link url="editParty" entity-name="mantle.party.PartyDetail" text="${pseudoId}"
                            link-type="anchor" parameter-map="[partyId:toPartyId]"/></default-field>
                </field>
                <!-- <field name="referenceNumber"><header-field title="Ref Num (PO/etc)"><text-find size="10" hide-options="true"/></header-field>
                    <default-field><display/></default-field></field> -->

                <field name="statusId">
                    <header-field title="Status" show-order-by="true">
                        <widget-template-include location="component://webroot/template/screen/BasicWidgetTemplates.xml#statusDropDown">
                            <set field="statusTypeId" value="Invoice"/><set field="allowMultiple" value="true"/></widget-template-include>
                    </header-field>
                    <default-field><display-entity entity-name="moqui.basic.StatusItem"/></default-field>
                </field>

                <field name="itemsTotal" align="right" show-total="sum"><header-field title="Items"><range-find/></header-field>
                    <default-field><display currency-unit-field="currencyUomId"/></default-field></field>

                <!-- PaymentApplication fields -->
                <field name="paymentId"><header-field title="Payment" show-order-by="true"/>
                    <default-field><link url="editPayment" text="${paymentId}" link-type="anchor"/></default-field></field>
                <field name="appliedDate"><header-field show-order-by="true"/>
                    <default-field><display/></default-field></field>
                <field name="amountApplied" align="right" show-total="sum">
                    <header-field title="Applied" show-order-by="true"><range-find/></header-field>
                    <default-field><display currency-unit-field="currencyUomId"/></default-field>
                </field>

                <field name="amountDiff" from="(itemsTotal?:0.0) - (amountApplied?:0.0)" align="right" show-total="sum">
                    <default-field title="Difference"><display currency-unit-field="currencyUomId"/></default-field>
                </field>

                <field name="findButton"><header-field title="Find"><submit/></header-field></field>
            </form-list>
        </box-body-nopad></container-box>

        <container-box><box-header title="Transactions not Posted"/><box-body-nopad>
            <form-list name="NotPostedTxList" list="notPostedTxList" skip-form="true">
                <entity-find entity-name="mantle.ledger.transaction.AcctgTrans" list="notPostedTxList">
                    <econdition field-name="transactionDate" operator="greater-equals" from="fromDate"/>
                    <econdition field-name="transactionDate" operator="less-equals" from="thruDate"/>
                    <econdition field-name="isPosted" operator="not-equals" value="Y" or-null="true"/>
                </entity-find>
                <row-actions>
                    <service-call name="mantle.ledger.LedgerServices.calculate#AcctgTransTrialBalance"
                            in-map="[acctgTransId:acctgTransId]" out-map="context"/>
                </row-actions>

                <field name="acctgTransId"><default-field title="Transaction">
                    <link url="editTransaction" text="${acctgTransId}" link-type="anchor"/></default-field></field>
                <field name="acctgTransTypeEnumId"><default-field title="Type">
                    <display-entity entity-name="moqui.basic.Enumeration"/></default-field></field>
                <field name="transactionDate"><default-field title="Date"><display/></default-field></field>
                <field name="otherPartyId"><default-field><link url="editParty" entity-name="mantle.party.PartyDetail"
                        text="PartyNameTemplate" link-type="anchor" parameter-map="[partyId:otherPartyId]"/></default-field></field>

                <field name="invoiceId"><default-field title="Invoice">
                    <link url="editInvoice" text="${invoiceId}" link-type="anchor"/></default-field></field>
                <field name="paymentId"><default-field title="Payment">
                    <link url="editPayment" text="${paymentId}" link-type="anchor"/></default-field></field>
                <field name="shipmentId"><default-field title="Shipment">
                    <link url="editShipment" text="${shipmentId}" link-type="anchor"/></default-field></field>
                <field name="assetId"><default-field title="Asset">
                    <link url="assetDetail" text="${assetId}" link-type="anchor"/></default-field></field>

                <field name="debitTotal" align="right"><default-field title="Total">
                    <display currency-unit-field="amountUomId"/></default-field></field>
            </form-list>
        </box-body-nopad></container-box>
        <container-box><box-header title="Transactions with no Invoice"/><box-body-nopad>
            <form-list name="NoInvoiceTxList" list="noInvoiceTxList" skip-form="true">
                <entity-find entity-name="mantle.ledger.transaction.AcctgTrans" list="noInvoiceTxList">
                    <econdition field-name="acctgTransTypeEnumId" operator="in" from="txTypeEnumIdList"/>
                    <econdition field-name="transactionDate" operator="greater-equals" from="fromDate"/>
                    <econdition field-name="transactionDate" operator="less-equals" from="thruDate"/>
                    <econdition field-name="invoiceId" operator="is-null"/>
                </entity-find>
                <row-actions>
                    <service-call name="mantle.ledger.LedgerServices.calculate#AcctgTransTrialBalance"
                            in-map="[acctgTransId:acctgTransId]" out-map="context"/>
                </row-actions>

                <field name="acctgTransId"><default-field title="Transaction">
                    <link url="editTransaction" text="${acctgTransId}" link-type="anchor"/></default-field></field>
                <field name="acctgTransTypeEnumId"><default-field title="Type">
                    <display-entity entity-name="moqui.basic.Enumeration"/></default-field></field>
                <field name="transactionDate"><default-field title="Date"><display/></default-field></field>
                <field name="otherPartyId"><default-field><link url="editParty" entity-name="mantle.party.PartyDetail"
                        text="PartyNameTemplate" link-type="anchor" parameter-map="[partyId:otherPartyId]"/></default-field></field>
                <field name="debitTotal" align="right"><default-field title="Total">
                    <display currency-unit-field="amountUomId"/></default-field></field>
            </form-list>
        </box-body-nopad></container-box>
        <container-box><box-header title="Payment Applications with Invoice after Period"/><box-body-nopad>
            <form-list name="ApplicationFutureInvoiceList" list="applicationFutureInvoiceList" skip-form="true">
                <entity-find entity-name="mantle.account.payment.PaymentApplicationAndInvoice" list="applicationFutureInvoiceList">
                    <econdition field-name="appliedDate" operator="greater-equals" from="fromDate"/>
                    <econdition field-name="appliedDate" operator="less-equals" from="thruDate"/>
                    <econdition field-name="invoiceDate" operator="greater" from="thruDate"/>
                </entity-find>
                <field name="paymentApplicationId"><default-field title="Application ID">
                    <display/></default-field></field>
                <field name="paymentId"><default-field title="Payment">
                    <link url="editPayment" text="${paymentId}" link-type="anchor"/></default-field></field>
                <field name="appliedDate"><default-field><display/></default-field></field>
                <field name="invoiceId"><default-field title="Invoice">
                    <link url="editInvoice" text="${invoiceId}" link-type="anchor"/></default-field></field>
                <field name="invoiceDate"><default-field><display/></default-field></field>
            </form-list>
        </box-body-nopad></container-box>
    </widgets>
</screen>
