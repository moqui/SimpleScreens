<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a 
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        default-menu-include="false">

    <parameter name="shipmentId" required="true"/>

    <transition name="updateShipment"><service-call name="mantle.shipment.ShipmentServices.update#ShipmentAndRouteSegment"/>
        <default-response url="."/></transition>

    <transition name="scheduleShipment">
        <service-call name="update#mantle.shipment.Shipment" in-map="[shipmentId:shipmentId, statusId:'ShipScheduled']"/>
        <default-response url="."/></transition>
    <transition name="pickShipment">
        <service-call name="update#mantle.shipment.Shipment" in-map="[shipmentId:shipmentId, statusId:'ShipPicked']"/>
        <default-response url="."/></transition>
    <transition name="packShipment"><service-call name="mantle.shipment.ShipmentServices.pack#Shipment"/>
        <default-response url="."/></transition>
    <transition name="shipShipment"><service-call name="mantle.shipment.ShipmentServices.ship#Shipment"/>
        <default-response url="."/></transition>
    <transition name="deliverShipment">
        <service-call name="update#mantle.shipment.Shipment" in-map="[shipmentId:shipmentId, statusId:'ShipDelivered']"/>
        <default-response url="."/></transition>
    <transition name="receiveEntireShipment"><service-call name="mantle.shipment.ShipmentServices.receive#EntireShipment"/>
        <default-response url="."/></transition>
    <transition name="cancelShipment">
        <!-- TODO: when shipment cancelled reset and disassociate from SO? -->
        <service-call name="update#mantle.shipment.Shipment" in-map="[shipmentId:shipmentId, statusId:'ShipCancelled']"/>
        <default-response url="."/>
    </transition>

    <transition name="validateAddress"><service-call name="mantle.shipment.CarrierServices.validate#PostalAddress"/>
        <default-response url="."/></transition>
    <transition name="requestShipmentLabels"><service-call name="mantle.shipment.CarrierServices.request#ShipmentLabels"/>
        <default-response url="."/></transition>
    <transition name="refundShipmentLabels"><service-call name="mantle.shipment.CarrierServices.refund#ShipmentLabels"/>
        <default-response url="."/></transition>
    <transition name="trackShipmentLabels"><service-call name="mantle.shipment.CarrierServices.track#ShipmentLabels"/>
        <default-response url="."/></transition>
    <transition name="removeShipmentLabelInfo"><service-call name="mantle.shipment.CarrierServices.remove#ShipmentLabelInfo"/>
        <default-response url="."/></transition>

    <transition name="sendShipmentStoreEmail"><service-call name="mantle.shipment.ShipmentServices.send#ShipmentStoreEmail"/>
        <default-response url="."/></transition>
    <transition name="orderDetail"><default-response url="//${appRoot}/Order/OrderDetail"/></transition>
    <transition name="editInvoice"><default-response url="//${appRoot}/Accounting/Invoice/EditInvoice"/></transition>
    <transition name="editPayment"><default-response url="//${appRoot}/Accounting/Payment/EditPayment"/></transition>
    <transition name="assetDetail"><default-response url="//${appRoot}/Asset/AssetDetail"/></transition>

    <transition name="createContent"><service-call name="mantle.shipment.ShipmentServices.create#ShipmentContent"/>
        <default-response url="."/></transition>
    <transition name="updateContent"><service-call name="mantle.shipment.ShipmentServices.update#ShipmentContent"/>
        <default-response url="."/></transition>
    <transition name="downloadContent"><parameter name="shipmentContentId"/>
        <actions><entity-find-one entity-name="mantle.shipment.ShipmentContent" value-field="shipmentContent"/>
            <script>ec.web.sendResourceResponse(shipmentContent.contentLocation)</script></actions>
        <default-response type="none"/>
    </transition>

    <transition-include name="searchPartyList" location="component://SimpleScreens/template/party/PartyForms.xml"/>
    <transition-include name="getProductList" location="component://SimpleScreens/template/product/ProductTransitions.xml"/>
    <transition-include name="getAssetList" location="component://SimpleScreens/template/product/ProductTransitions.xml"/>

    <transition name="addItem"><service-call name="mantle.shipment.ShipmentServices.create#ShipmentItem"/>
        <default-response url="."/></transition>
    <transition name="updateItem"><service-call name="mantle.shipment.ShipmentServices.update#ShipmentItem"/>
        <default-response url="."/></transition>
    <transition name="packItem"><service-call name="mantle.shipment.ShipmentServices.pack#ShipmentProduct"/>
        <default-response url="."/></transition>
    <transition name="packItemSource"><service-call name="mantle.shipment.ShipmentServices.pack#ShipmentItemSource"/>
        <default-response url="."/></transition>
    <transition name="createPackage"><service-call name="mantle.shipment.ShipmentServices.create#ShipmentPackage"/>
        <default-response url="."/></transition>
    <transition name="updatePackageAndRouteSeg"><service-call name="mantle.shipment.ShipmentServices.update#ShipmentPackageAndRouteSeg"/>
        <default-response url="."/></transition>
    <transition name="addItemToPackage"><service-call name="mantle.shipment.ShipmentServices.add#ItemToPackage"/>
        <default-response url="."/></transition>
    <transition name="updatePackageContent"><service-call name="mantle.shipment.ShipmentServices.update#ShipmentPackageContent"/>
        <default-response url="."/></transition>
    <transition name="createShipmentAutoPackages"><service-call name="mantle.shipment.ShipmentServices.create#ShipmentAutoPackages"/>
        <default-response url="."/></transition>

    <transition name="getShippingOptions"><actions>
        <service-call name="mantle.shipment.ShipmentServices.get#ShipmentShippingOptions" out-map="shipOptsOut"
                in-map="[shipmentId:shipmentId, getRates:true]"/>
        <script>
            outList = []
            for (sop in shipOptsOut.shippingOptions) outList.add([value:"${sop.carrierPartyId}:${sop.shipmentMethodEnumId}",
                label:"${sop.carrierPartyId != '_NA_' ? (sop.carrierName + ' - ') : ''}${sop.shipmentMethodDescription}${sop.shippingTotal != null ? ' ' + ec.l10n.format(sop.shippingTotal, '#,##0.00') : ''}"])
            ec.web.sendJsonResponse(outList)
        </script>
    </actions><default-response type="none"/></transition>

    <transition name="EmailMessage" read-only="true"><parameter name="emailMessageId"/><actions>
        <entity-find-one entity-name="moqui.basic.email.EmailMessage" value-field="emailMessage"/>
        <script>ec.web.sendTextResponse(emailMessage?.body, "text/html", null)</script>
    </actions><default-response type="none"/></transition>
    <transition name="ShipmentPick.pdf">
        <default-response url="${ec.web.getWebappRootUrl(false, null)}/fop/apps/${appRoot}/Shipment/ShipmentPick" url-type="plain">
            <parameter name="renderMode" value="xsl-fo"/><parameter name="pageNoLimit" value="true"/>
            <parameter name="shipmentId"/><parameter name="filename" value="ShipmentPick-${shipmentId}.pdf"/>
        </default-response>
    </transition>
    <transition name="ShipmentPack.pdf">
        <default-response url="${ec.web.getWebappRootUrl(false, null)}/fop/apps/${appRoot}/Shipment/ShipmentPack" url-type="plain">
            <parameter name="renderMode" value="xsl-fo"/><parameter name="pageNoLimit" value="true"/>
            <parameter name="shipmentId"/><parameter name="filename" value="ShipmentPack-${shipmentId}.pdf"/>
        </default-response>
    </transition>
    <transition name="ShipmentByPackage.pdf">
        <default-response url="${ec.web.getWebappRootUrl(false, null)}/fop/apps/${appRoot}/Shipment/ShipmentByPackage" url-type="plain">
            <parameter name="renderMode" value="xsl-fo"/><parameter name="pageNoLimit" value="true"/>
            <parameter name="shipmentId"/><parameter name="filename" value="ShipmentByPackage-${shipmentId}.pdf"/>
        </default-response>
    </transition>

    <subscreens>
        <subscreens-item name="UpdateContactInfo" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/UpdateContactInfo.xml"/>
    </subscreens>
    <actions>
        <service-call name="mantle.shipment.ShipmentServices.get#ShipmentDisplayInfo" in-map="[shipmentId:shipmentId]" out-map="context"/>

        <entity-find entity-name="mantle.facility.Facility" list="facilityList">
            <econdition field-name="facilityTypeEnumId" value="FcTpWarehouse"/>
            <order-by field-name="facilityName"/>
        </entity-find>

        <if condition="isIncoming"><then>
            <set field="anyReceived" from="false"/>
            <iterate list="shipmentItemDetailList" entry="sid">
                <if condition="sid.quantityAcceptedTotal || sid.quantityRejectedTotal"><set field="anyReceived" from="true"/></if>
            </iterate>
        </then><else>
            <set field="allItemsPacked" from="true"/>
            <iterate list="shipmentItemSourceList" entry="sisCheck">
                <if condition="sisCheck.quantityNotHandled &gt; 0"><set field="allItemsPacked" from="false"/><break/></if></iterate>

            <set field="hasAllLabels" from="true"/><set field="hasAnyLabels" from="false"/>
            <iterate list="packageRouteSegList" entry="packageRouteSeg">
                <if condition="packageRouteSeg.trackingCode"><then><set field="hasAnyLabels" from="true"/></then>
                    <else><set field="hasAllLabels" from="false"/></else></if>
            </iterate>

            <set field="shippingGatewayConfigId" from="firstRouteSegment.shippingGatewayConfigId ?: ec.user.getPreference('DefaultShipmentGatewayConfigId')"/>
            <if condition="shippingGatewayConfigId"><entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayConfig" value-field="shippingGatewayConfig"/></if>
        </else></if>

        <set field="shippingPostalAddressList" from="[]"/>
        <if condition="toPartyId &amp;&amp; !isIncoming">
            <service-call name="mantle.party.ContactServices.get#PartyContactInfoList" out-map="toPartyShippingInfo"
                    in-map="[partyId:toPartyId, postalContactMechPurposeId:'PostalShippingDest']"/>
            <set field="shippingPostalAddressList" from="toPartyShippingInfo.postalAddressList ?: []"/>

            <if condition="firstRouteSegment.destPostalContactMechId">
                <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="curPaInfo"
                        in-map="[partyId:toPartyId, postalContactMechId:firstRouteSegment.destPostalContactMechId]"/>
                <if condition="!(firstRouteSegment.destPostalContactMechId in shippingPostalAddressList*.postalContactMechId)">
                    <script>shippingPostalAddressList.add(0, curPaInfo)</script></if>
            </if>
        </if>

        <if condition="!isIncoming">
            <!-- get shippingOptions for initial load (before drop-down dynamic call with rates which may be slow) -->
            <service-call name="mantle.shipment.ShipmentServices.get#ShipmentShippingOptions" out-map="context"
                    in-map="[shipmentId:shipmentId, getRates:false]"/>

            <entity-find-one entity-name="mantle.party.PartyDetail" value-field="curCarrierDetail" cache="true">
                <field-map field-name="partyId" from="firstRouteSegment.carrierPartyId"/></entity-find-one>
            <entity-find-one entity-name="moqui.basic.Enumeration" value-field="curShipmentMethodEnum">
                <field-map field-name="enumId" from="firstRouteSegment.shipmentMethodEnumId"/></entity-find-one>
        </if>
    </actions>
    <widgets>
        <container-row><row-col md="6">
            <label text="Shipment #${shipmentId}" type="h3"/>

            <!-- Links -->
            <section name="ShipInputSection" condition="shipment.statusId == 'ShipInput'"><widgets>
                <section name="ShipInputInOutSection" condition="isIncoming"><widgets>
                    <link url="scheduleShipment" text="Set Scheduled"><parameter name="shipmentId"/></link>
                    <link url="shipShipment" text="Set Shipped"><parameter name="shipmentId"/></link>
                    <link url="cancelShipment" text="Cancel Shipment"><parameter name="shipmentId"/></link>
                </widgets><fail-widgets>
                    <link url="scheduleShipment" text="Set Scheduled"><parameter name="shipmentId"/></link>
                    <link url="pickShipment" text="Set Picked"><parameter name="shipmentId"/></link>
                    <link url="cancelShipment" text="Cancel Shipment"><parameter name="shipmentId"/></link>
                </fail-widgets></section>
            </widgets></section>
            <section name="ShipScheduledSection" condition="shipment.statusId == 'ShipScheduled'"><widgets>
                <section name="ShipScheduledInOutSection" condition="isIncoming"><widgets>
                    <link url="shipShipment" text="Set Shipped"><parameter name="shipmentId"/></link>
                    <link url="deliverShipment" text="Set Delivered" condition="anyReceived"><parameter name="shipmentId"/></link>
                    <link url="receiveEntireShipment" text="Receive Entire Shipment"><parameter name="shipmentId"/></link>
                    <link url="cancelShipment" text="Cancel Shipment" condition="!anyReceived"><parameter name="shipmentId"/></link>
                </widgets><fail-widgets>
                    <link url="pickShipment" text="Set Picked"><parameter name="shipmentId"/></link>
                    <link url="packShipment" text="Set Packed" condition="allItemsPacked"><parameter name="shipmentId"/></link>
                    <link url="cancelShipment" text="Cancel Shipment"><parameter name="shipmentId"/></link>
                    <link url="ShipmentPick.pdf" text="Pick PDF"/>
                    <link url="ShipmentByPackage.pdf" text="Package PDF"/>
                    <link url="ShipmentPack.pdf" text="Pack Insert PDF"/>
                </fail-widgets></section>
            </widgets></section>
            <section name="ShipPickedSection" condition="shipment.statusId == 'ShipPicked'"><widgets>
                <section name="ShipPickedInOuSection" condition="isIncoming"><widgets>
                    <link url="shipShipment" text="Set Shipped"><parameter name="shipmentId"/></link>
                    <link url="cancelShipment" text="Cancel Shipment" condition="!anyReceived"><parameter name="shipmentId"/></link>
                </widgets><fail-widgets>
                    <link url="packShipment" text="Set Packed" condition="allItemsPacked"><parameter name="shipmentId"/></link>
                    <link url="cancelShipment" text="Cancel Shipment"><parameter name="shipmentId"/></link>
                    <link url="ShipmentPick.pdf" text="Pick PDF"/>
                </fail-widgets></section>
                <link url="ShipmentByPackage.pdf" text="Package PDF"/>
                <link url="ShipmentPack.pdf" text="Pack Insert PDF"/>
            </widgets></section>
            <section name="ShipPackedSection" condition="shipment.statusId == 'ShipPacked'"><widgets>
                <section name="ShipPackedInOutSection" condition="isIncoming"><widgets>
                    <link url="shipShipment" text="Set Shipped"><parameter name="shipmentId"/></link>
                    <link url="deliverShipment" text="Set Delivered" condition="anyReceived"><parameter name="shipmentId"/></link>
                    <link url="receiveEntireShipment" text="Receive Entire Shipment"><parameter name="shipmentId"/></link>
                    <link url="cancelShipment" text="Cancel Shipment" condition="!anyReceived"><parameter name="shipmentId"/></link>
                </widgets><fail-widgets>
                    <link url="requestShipmentLabels" text="Get Labels" condition="shippingGatewayConfigId &amp;&amp; !hasAllLabels"/>
                    <link url="trackShipmentLabels" text="Track Labels" condition="shippingGatewayConfigId &amp;&amp; hasAnyLabels"/>
                    <link url="shipShipment" text="Set Shipped"/>
                    <link url="deliverShipment" text="Set Delivered"/>
                    <link url="ShipmentPick.pdf" text="Pick PDF"/>
                    <link url="ShipmentByPackage.pdf" text="Package PDF"/>
                    <link url="ShipmentPack.pdf" text="Pack Insert PDF"/>
                </fail-widgets></section>
            </widgets></section>
            <section name="ShipShippedSection" condition="shipment.statusId == 'ShipShipped'"><widgets>
                <section name="ShipShippedInOutSection" condition="isIncoming"><widgets>
                    <link url="deliverShipment" text="Set Delivered" condition="anyReceived"><parameter name="shipmentId"/></link>
                    <link url="receiveEntireShipment" text="Receive Entire Shipment" ><parameter name="shipmentId"/></link>
                    <link url="cancelShipment" text="Cancel Shipment" condition="!anyReceived"><parameter name="shipmentId"/></link>
                </widgets><fail-widgets>
                    <link url="requestShipmentLabels" text="Get Labels" condition="shippingGatewayConfigId &amp;&amp; !hasAllLabels"/>
                    <link url="trackShipmentLabels" text="Track Labels" condition="shippingGatewayConfigId &amp;&amp; hasAnyLabels"/>
                    <link url="deliverShipment" text="Set Delivered"/>
                    <link url="ShipmentPick.pdf" text="Pick PDF"/>
                    <link url="ShipmentByPackage.pdf" text="Package PDF"/>
                    <link url="ShipmentPack.pdf" text="Pack Insert PDF"/>
                </fail-widgets></section>
            </widgets></section>

            <section-iterate name="OrderLinks" list="orderIdSet" entry="orderId"><widgets>
                <link url="orderDetail" text="Order #${orderId}" link-type="anchor-button"/></widgets></section-iterate>
            <section-iterate name="InvoiceLinks" list="invoiceIdSet" entry="invoiceId"><widgets>
                <link url="editInvoice" text="Invoice #${invoiceId}" link-type="anchor-button"/></widgets></section-iterate>

            <label text="Shipping Gateway: ${shippingGatewayConfig.description}" type="p" condition="shippingGatewayConfig != null"/>

            <!-- Header -->
            <section name="ShipmentHeaderSection" condition="allowUpdate || shipment.statusId == 'ShipPacked'"><widgets>
                <section name="DestPostalAddressSection" condition="!isIncoming"><widgets>
                    <dynamic-dialog id="AddPostalInfo" button-text="Add Shipping Address" transition="UpdateContactInfo" width="800"
                            parameter-map="[partyId:toPartyId, postalContactMechPurposeId:'PostalShippingDest', shipmentId:shipmentId]"/>
                    <label text="No shipping address selected" style="text-danger" type="p" condition="!firstRouteSegment.destPostalContactMechId"/>
                    <container style="float-box" type="ul">
                        <section-iterate name="ShippingAddressList" list="shippingPostalAddressList" entry="contactInfo"><actions>
                            <set field="checkRadio" from="(firstRouteSegment.destPostalContactMechId &amp;&amp; firstRouteSegment.destPostalContactMechId == contactInfo.postalContactMechId)"/>
                        </actions><widgets>
                            <container type="li" style="box-narrow">
                                <render-mode><text type="html,vuet"><![CDATA[
                                    <div class="text-center"><input type="radio" name="shippingPostalContactMechId" value="${contactInfo.postalContactMechId}"<#if checkRadio> checked="checked"</#if>></div>
                                ]]></text></render-mode>
                                <render-mode><text type="html,vuet" location="component://SimpleScreens/template/party/ContactInfo.html.gstring"/></render-mode>
                                <dynamic-dialog id="UpdatePostalInfo" button-text="Update Address" transition="UpdateContactInfo"
                                        width="800" condition="allowUpdate"
                                        parameter-map="[partyId:toPartyId, postalContactMechId:contactInfo.postalContactMechId,
                                                postalContactMechPurposeId:contactInfo.postalContactMechPurposeId, shipmentId:shipmentId]"/>

                                <container>
                                    <label text="Trust: ${contactInfo.postalTrustLevelEnum?.description ?: 'New'}" type="strong"/>
                                    <link url="validateAddress" text="Validate"
                                            parameter-map="[shipmentId:shipmentId, partyId:toPartyId, contactMechId:contactInfo.postalContactMechId]"
                                            condition="!contactInfo.postalContactMech.trustLevelEnumId || contactInfo.postalContactMech.trustLevelEnumId == 'CmtlNew'"/>
                                </container>
                                <label text="${contactInfo.postalContactMech.validateMessage?:''}" type="div"/>
                            </container>
                        </widgets></section-iterate>
                    </container>
                    <label text="No shipment method selected" style="text-warning" type="p" condition="!firstRouteSegment.shipmentMethodEnumId"/>
                </widgets></section>

                <form-single name="EditShipment" transition="updateShipment" map="shipment">
                    <field name="shipmentId"><default-field><hidden/></default-field></field>
                    <field name="destPostalContactMechId"><default-field><hidden/></default-field></field>

                    <field name="carrierAndShipmentMethod"><conditional-field title="Shipment Method" condition="!hasAllLabels">
                        <drop-down allow-empty="true" no-current-selected-key="${firstRouteSegment.carrierPartyId ? firstRouteSegment.carrierPartyId + ':' + firstRouteSegment.shipmentMethodEnumId : ''}">
                            <list-options list="shippingOptions" key="${carrierPartyId}:${shipmentMethodEnumId}"
                                    text="${carrierPartyId != '_NA_' ? (carrierName + ' - ') : ''}${shipmentMethodDescription}${shippingTotal != null ? ' ' + ec.l10n.formatCurrency(shippingTotal, orderHeader.currencyUomId) : ''}"/>
                            <dynamic-options transition="getShippingOptions"/>
                        </drop-down>
                    </conditional-field></field>

                    <field name="shipmentTypeEnumId"><default-field title="Shipment Type">
                        <display text="${shipmentTypeEnum.description}" also-hidden="false"/></default-field></field>
                    <field name="statusId"><default-field title="Status">
                        <display text="${statusItem.description}" also-hidden="false"/></default-field></field>

                    <!-- Incoming Shipment Fields -->
                    <field name="fromPartyId"><conditional-field title="From Party" condition="isIncoming">
                        <drop-down allow-empty="true"><dynamic-options transition="searchPartyList" server-search="true" min-length="2"/></drop-down>
                    </conditional-field></field>
                    <field name="destinationFacilityId" from="lastRouteSegment.destinationFacilityId">
                        <conditional-field title="Destination Facility" condition="isIncoming">
                            <drop-down><list-options list="facilityList" key="${facilityId}" text="FacilityNameTemplate"/></drop-down>
                        </conditional-field>
                    </field>

                    <!-- Outgoing Shipment Fields -->
                    <field name="toPartyId"><conditional-field title="To Party" condition="!isIncoming &amp;&amp; allowUpdate">
                        <drop-down allow-empty="true"><dynamic-options transition="searchPartyList" server-search="true" min-length="2"/></drop-down>
                    </conditional-field><conditional-field condition="!isIncoming" title="To Party">
                        <label text="${toPartyDetail ? ec.resource.expand('PartyNameTemplate', '', toPartyDetail) : 'Not Set'}"/>
                    </conditional-field></field>
                    <field name="originFacilityId" from="firstRouteSegment.originFacilityId">
                        <conditional-field title="Origin Facility" condition="!isIncoming &amp;&amp; allowUpdate">
                            <drop-down><list-options list="facilityList" key="${facilityId}" text="FacilityNameTemplate"/></drop-down>
                        </conditional-field>
                        <conditional-field title="Origin Facility" condition="!isIncoming">
                            <label text="${ec.resource.expand('FacilityNameTemplate', '', originFacility)}"/>
                        </conditional-field>
                    </field>
                    <field name="estimatedReadyDate"><conditional-field condition="!isIncoming"><date-time/></conditional-field></field>
                    <field name="estimatedArrivalDate"><default-field><date-time/></default-field></field>

                    <field name="submitButton"><default-field title="Update Shipment"><submit/></default-field></field>

                    <field-layout>
                        <field-ref name="carrierAndShipmentMethod"/>
                        <field-row><field-ref name="shipmentTypeEnumId"/><field-ref name="statusId"/></field-row>
                        <fields-not-referenced/>
                        <field-row><field-ref name="estimatedReadyDate"/><field-ref name="estimatedArrivalDate"/></field-row>
                        <field-ref name="submitButton"/>
                    </field-layout>
                </form-single>
                <render-mode><text type="html,vuet"><![CDATA[
                    <script>
                        $("#EditShipment_destPostalContactMechId").val($("input[name=shippingPostalContactMechId]:checked").val());
                        $("input[name=shippingPostalContactMechId]:radio").change( function() { $("#EditShipment_destPostalContactMechId").val($("input[name=shippingPostalContactMechId]:checked").val()); })
                    </script>
                ]]></text></render-mode>
            </widgets><fail-widgets>
                <section name="ShipmentDisplaySection" condition="isIncoming"><widgets>
                    <label text="From ${fromPartyDetail ? ec.resource.expand('PartyNameTemplate', '', fromPartyDetail) : 'Not Set'}" type="p"/>
                    <label text="Destination Facility ${ec.resource.expand('FacilityNameTemplate', '', destinationFacility)}" type="p"/>
                    <label text="Status ${statusItem.description}" type="p"/>
                    <label text="Estimated arrival: ${ec.l10n.format(shipment.estimatedArrivalDate, 'yyyy-MM-dd HH:mm') ?: 'Unknown'}" type="p"/>
                </widgets><fail-widgets>
                    <label text="To ${toPartyDetail ? ec.resource.expand('PartyNameTemplate', '', toPartyDetail) : 'Not Set'}" type="p"/>
                    <label text="Origin Facility ${ec.resource.expand('FacilityNameTemplate', '', originFacility)}" type="p"/>
                    <label text="Status ${statusItem.description}" type="p"/>
                    <label text="Estimated ready: ${ec.l10n.format(shipment.estimatedReadyDate, 'yyyy-MM-dd HH:mm') ?: 'Not Set'}" type="p"/>
                    <label text="Ship by ${curCarrierDetail ? ec.resource.expand('PartyNameTemplate','',curCarrierDetail) : 'N/A'} - ${shipmentMethodEnum?.description ?: 'None'}" type="p"/>
                    <section name="ShippedShippingInfo" condition="curPaInfo"><actions><set field="contactInfo" from="curPaInfo"/></actions><widgets>
                        <render-mode><text type="html,vuet" location="component://SimpleScreens/template/party/ContactInfo.html.gstring"/></render-mode>
                        <container><label text="Trust: ${contactInfo.postalTrustLevelEnum?.description ?: 'New'}" type="strong"/></container>
                        <label text="${contactInfo.postalContactMech.validateMessage?:''}" type="div"/>
                    </widgets></section>
                </fail-widgets></section>
            </fail-widgets></section>
        </row-col><row-col md="6">
            <section-include name="StatusHistorySection" location="component://SimpleScreens/template/basic/StatusWidgets.xml"/>

            <container-box><box-header><label text="Payments" type="h5"/></box-header><box-body-nopad>
                <form-list name="ShipmentOrderPaymentList" list="shipmentPaymentList">
                    <entity-find entity-name="mantle.shipment.ShipmentOrderPayment" list="shipmentPaymentList" distinct="true">
                        <econdition field-name="shipmentId"/>
                        <select-field field-name="orderId,paymentId,paymentInstrumentEnumId,statusId,paymentRefNum,amountUomId"/>
                        <order-by field-name="orderId,paymentId"/>
                    </entity-find>
                    <field name="orderId"><default-field title="Order">
                        <link url="orderDetail" text="${orderId}" link-type="anchor"/></default-field></field>
                    <field name="paymentId"><default-field title="Payment">
                        <link url="editPayment" text="${paymentId}" link-type="anchor"/></default-field></field>
                    <field name="amount"><default-field title="Amount"><display currency-unit-field="amountUomId"/></default-field></field>
                    <field name="paymentInstrumentEnumId"><default-field title="Instrument">
                        <display-entity entity-name="moqui.basic.Enumeration"/></default-field></field>
                    <field name="statusId"><default-field title="Status" container-style="strong ${statusId in ['PmntDelivered','PmntConfirmed'] ? 'text-success' : 'text-danger'}">
                        <display-entity entity-name="moqui.basic.StatusItem"/></default-field></field>
                    <field name="paymentRefNum" from="payment?.paymentRefNum"><default-field title="Ref"><display/></default-field></field>
                </form-list>
                <form-list name="ShipmentInvoicePaymentList" list="shipmentPaymentList">
                    <entity-find entity-name="mantle.shipment.ShipmentInvoicePayment" list="shipmentPaymentList" distinct="true">
                        <econdition field-name="shipmentId"/>
                        <select-field field-name="invoiceId,paymentId,amountApplied,appliedDate,paymentInstrumentEnumId,statusId,paymentRefNum,amountUomId"/>
                        <order-by field-name="invoiceId,paymentId"/>
                    </entity-find>
                    <field name="invoiceId"><default-field title="Invoice">
                        <link url="editInvoice" text="${invoiceId}" link-type="anchor"/></default-field></field>
                    <field name="paymentId"><default-field title="Payment">
                        <link url="editPayment" text="${paymentId}" link-type="anchor"/></default-field></field>
                    <field name="amountApplied"><default-field title="Amount"><display currency-unit-field="amountUomId"/></default-field></field>
                    <field name="appliedDate"><default-field title="Applied"><display/></default-field></field>
                    <field name="paymentInstrumentEnumId"><default-field title="Instrument">
                        <display-entity entity-name="moqui.basic.Enumeration"/></default-field></field>
                    <field name="statusId"><default-field title="Status" container-style="strong ${statusId in ['PmntDelivered','PmntConfirmed'] ? 'text-success' : 'text-danger'}">
                        <display-entity entity-name="moqui.basic.StatusItem"/></default-field></field>
                    <field name="paymentRefNum" from="payment?.paymentRefNum"><default-field title="Ref"><display/></default-field></field>
                </form-list>
            </box-body-nopad></container-box>

            <container-box><box-header><label text="Content" type="h5"/></box-header><box-toolbar>
                <container-dialog id="NewContentDialog" button-text="Add Content">
                    <form-single name="NewContentForm" transition="createContent">
                        <field name="shipmentId"><default-field><hidden/></default-field></field>
                        <field name="contentFile"><default-field><file/></default-field></field>
                        <field name="description"><default-field><text-line size="60"/></default-field></field>
                        <field name="submitButton"><default-field title="Add Attachment"><submit/></default-field></field>
                    </form-single>
                </container-dialog>
            </box-toolbar><box-body>
                <section-iterate name="ContentIterateSection" list="contentList" entry="content"><actions>
                    <entity-find-one entity-name="mantle.party.PersonWithUserAccount" value-field="paua">
                        <field-map field-name="userId" from="content.userId"/></entity-find-one>
                </actions><widgets>
                    <container>
                        <link url="downloadContent" condition="content.contentLocation"
                                parameter-map="[shipmentContentId:content.shipmentContentId]"
                                text="Download ${content.contentLocation.substring(content.contentLocation.lastIndexOf('/')+1)}"/>
                        <container-dialog id="UpdateContentContainer" button-text="Edit Attachment">
                            <form-single name="UpdateContentForm" transition="updateContent" map="content">
                                <field name="shipmentContentId"><default-field><hidden/></default-field></field>
                                <field name="shipmentId"><default-field><hidden/></default-field></field>
                                <field name="contentFile"><default-field><file/></default-field></field>
                                <field name="description"><default-field><text-line size="60"/></default-field></field>
                                <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                        <container><label text="By ${paua?.firstName?:''} ${paua?.lastName?:''} (${paua?.username ?: content.userId}) at ${ec.l10n.format(content.contentDate, 'yyyy-MM-dd HH:mm')}"/></container>
                        <label text="${content.description ?: 'No Description'}" type="p"/>
                    </container>
                </widgets></section-iterate>
            </box-body></container-box>

            <section name="EmailMessageSection"><widgets>
                <container-box><box-header><label text="Email Messages" type="h5"/></box-header><box-toolbar>
                    <section name="SendPlacedEmailSection" condition="shipment.statusId in ['ShipPacked', 'ShipShipped', 'ShipDelivered']"><actions>
                        <if condition="shipment.toPartyId">
                            <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="emailInfo"
                                    in-map="[partyId:shipment.toPartyId, emailContactMechPurposeId:'EmailOrder', defaultToPrimaryPurpose:true]"/>
                            <set field="toAddresses" from="emailInfo.emailAddress"/>
                        </if>
                    </actions><widgets>
                        <container-dialog id="SendPlacedEmailDialog" button-text="Send Email">
                            <form-single name="SendPlacedEmailForm" transition="sendShipmentStoreEmail">
                                <field name="shipmentId"><default-field><hidden/></default-field></field>
                                <field name="emailTypeEnumId" from="'PsetShipmentShipped'"><default-field><hidden/></default-field></field>
                                <field name="toAddresses"><default-field title="To Address"><text-line size="40"/></default-field></field>
                                <field name="submitButton"><default-field title="Send Email"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                    </widgets></section>
                </box-toolbar><box-body>
                    <form-list name="EmailMessageList" list="emailMessageList" skip-form="true">
                        <entity-find entity-name="mantle.shipment.ShipmentEmailMessageDetail" list="emailMessageList">
                            <econdition field-name="shipmentId"/><order-by field-name="sentDate,emailMessageId"/></entity-find>
                        <field name="emailMessageId"><default-field title="ID">
                            <link url="EmailMessage" text="${emailMessageId}" link-type="anchor" target-window="_blank"/>
                        </default-field></field>
                        <field name="sentDate"><default-field><display/></default-field></field>
                        <field name="toAddresses"><default-field><display/></default-field></field>
                        <field name="statusId"><default-field title="Status">
                            <display-entity entity-name="moqui.basic.StatusItem"/></default-field></field>
                        <field name="receivedDate"><default-field><display/></default-field></field>
                        <field name="emailTypeEnumId"><default-field title="Email Type">
                            <display-entity entity-name="moqui.basic.Enumeration"/></default-field></field>
                    </form-list>
                </box-body></container-box>
            </widgets></section>
        </row-col></container-row>

        <!-- Items -->
        <container-box><box-header><label text="Shipment Items" type="h5"/></box-header><box-toolbar>
            <section name="ShipItemInputSection" condition="shipment.statusId == 'ShipInput'"><widgets>
                <container-dialog id="AddItemContainer" button-text="Add Item">
                    <form-single name="AddItemForm" transition="addItem">
                        <field name="shipmentId"><default-field><hidden/></default-field></field>
                        <field name="productId"><default-field title="Product">
                            <drop-down><dynamic-options transition="getProductList" server-search="true" min-length="0"/></drop-down>
                        </default-field></field>
                        <field name="quantity"><default-field><text-line size="10"/></default-field></field>
                        <field name="submitButton"><default-field title="Add Item"><submit/></default-field></field>
                    </form-single>
                </container-dialog>
            </widgets></section>
        </box-toolbar><box-body>
            <section-iterate name="ShipmentItemsSection" list="shipmentItemDetailList" entry="sid"><actions>
                <if condition="isIncoming"><then>
                    <set field="quantityRemaining" from="sid.quantity - (sid.quantityAcceptedTotal ?: 0) - (sid.quantityRejectedTotal ?: 0)"/>
                    <entity-find entity-name="mantle.product.asset.AssetAndReceipt" list="assetReceiptList">
                        <econdition field-name="shipmentId"/><econdition field-name="productId" from="sid.productId"/></entity-find>
                </then><else>
                    <set field="quantityRemaining" from="sid.quantity - (sid.quantityTotal ?: 0)"/>
                    <entity-find entity-name="mantle.product.issuance.AssetAndIssuance" list="assetIssuanceList">
                        <econdition field-name="shipmentId"/><econdition field-name="productId" from="sid.productId"/></entity-find>
                </else></if>
                <set field="allowPack" from="!isIncoming &amp;&amp; shipment.statusId in ['ShipScheduled', 'ShipPicked'] &amp;&amp; quantityRemaining &gt; 0"/>
                <set field="allowReceive" from="isIncoming &amp;&amp; shipment.statusId in ['ShipScheduled', 'ShipShipped'] &amp;&amp; quantityRemaining &gt; 0"/>

                <entity-find-one entity-name="moqui.basic.Uom" value-field="productUom">
                    <field-map field-name="uomId" from="sid.amountUomId"/></entity-find-one>
                <entity-find entity-name="mantle.shipment.ShipmentItemSource" list="sisList">
                    <econdition field-name="shipmentId"/><econdition field-name="productId" from="sid.productId"/></entity-find>
                <entity-find-one entity-name="mantle.product.Product" value-field="product">
                    <field-map field-name="productId" from="sid.productId"/></entity-find-one>

                <entity-find entity-name="mantle.shipment.ShipmentPackageContent" list="packageContentList">
                    <econdition field-name="shipmentId"/><econdition field-name="productId" from="sid.productId"/></entity-find>
                <set field="packageContentTotal" from="(packageContentList*.quantity).sum() ?: 0.0"/>
                <set field="quantityNotInPackage" from="((BigDecimal) sid.quantity ?: 0.0) - packageContentTotal"/>
            </actions><widgets>
                <container-box><box-header><label text="ProductNameTemplate" text-map="sid" type="h5"/></box-header><box-toolbar>
                    <section name="PackItemSection" condition="allowPack"><widgets>
                        <container-dialog id="PackItemContainer" button-text="Pack Item">
                            <form-single name="PackItemForm" transition="packItem" map="sid">
                                <field name="shipmentId"><default-field><hidden/></default-field></field>
                                <field name="productId"><default-field><hidden/></default-field></field>
                                <field name="shipmentPackageSeqId"><default-field title="Package"><drop-down>
                                    <option key="" text="New Package"/>
                                    <list-options list="shipmentPackageList" key="${shipmentPackageSeqId}" text="${shipmentPackageSeqId}"/>
                                </drop-down></default-field></field>
                                <field name="quantity" from="quantityRemaining">
                                    <default-field><text-line size="8"/></default-field></field>
                                <field name="assetId"><default-field title="Asset">
                                    <drop-down><dynamic-options transition="getAssetList" server-search="true" min-length="0"
                                            parameter-map="[facilityId:firstRouteSegment.originFacilityId, productId:productId, assetTypeEnumId:null]"/></drop-down>
                                </default-field></field>
                                <field name="submitButton"><default-field title="Pack Quantity"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                    </widgets></section>
                    <section name="ReceiveItemSection" condition="allowReceive"><widgets>
                        <dynamic-dialog id="ReceiveProductContainer" button-text="Receive Product" transition="ReceiveItem" width="800">
                            <parameter name="shipmentId"/><parameter name="productId" from="sid.productId"/>
                            <parameter name="statusId" value="AstAvailable"/></dynamic-dialog>
                    </widgets></section>
                </box-toolbar><box-body>
                    <container-row>
                        <row-col lg="5">
                            <label condition="isIncoming" text="Total: ${ec.l10n.format(sid.quantity ?: 0, '#.##')}, Accepted: ${ec.l10n.format(sid.quantityAcceptedTotal ?: 0, '#.##')}, Rejected: ${ec.l10n.format(sid.quantityRejectedTotal ?: 0, '#.##')}, Remaining: ${ec.l10n.format(quantityRemaining, '#.##')}  (Unit: ${productUom?.description ?: 'N/A'})"/>
                            <label condition="!isIncoming" text="Total: ${ec.l10n.format(sid.quantity ?: 0, '#.##')}, Packed/Issued: ${ec.l10n.format(sid.quantityTotal ?: 0, '#.##')}, Remaining: ${ec.l10n.format(quantityRemaining, '#.##')}  (Unit: ${productUom?.description ?: 'N/A'})"/>
                        </row-col>
                        <row-col lg="3">
                            <section name="ShipItemUpdateSection" condition="allowUpdate"><widgets>
                                <form-single name="UpdateItemForm" transition="updateItem" map="sid">
                                    <field name="shipmentId"><default-field><hidden/></default-field></field>
                                    <field name="productId"><default-field><hidden/></default-field></field>
                                    <field name="quantity"><default-field title=""><text-line size="6"/></default-field></field>
                                    <field name="submitButton"><default-field title="Update Quantity"><submit/></default-field></field>
                                    <field-layout><field-row-big><field-ref name="quantity"/><field-ref name="submitButton"/></field-row-big></field-layout>
                                </form-single>
                            </widgets></section>
                        </row-col>
                        <row-col lg="4">
                            <section name="ShipItemPackageSection"><widgets>
                                <form-single name="AddItemToPackageForm" transition="addItemToPackage" map="sid">
                                    <field name="shipmentId"><default-field><hidden/></default-field></field>
                                    <field name="productId"><default-field><hidden/></default-field></field>
                                    <field name="shipmentPackageSeqId"><default-field title=""><drop-down>
                                        <option key="" text="New"/>
                                        <list-options list="shipmentPackageList" key="${shipmentPackageSeqId}" text="${shipmentPackageSeqId}"/>
                                    </drop-down></default-field></field>
                                    <field name="quantity" from="quantityNotInPackage"><default-field title="">
                                        <text-line size="6"/></default-field></field>
                                    <field name="submitButton"><default-field title="Add To Package"><submit/></default-field></field>
                                    <field-layout><field-row-big><field-ref name="shipmentPackageSeqId"/>
                                        <field-ref name="quantity"/><field-ref name="submitButton"/></field-row-big></field-layout>
                                </form-single>
                            </widgets></section>
                        </row-col>
                    </container-row>
                </box-body><box-body-nopad>
                    <section name="ItemAssetSection" condition="isIncoming"><widgets>
                        <form-list name="ItemSourceReceiptList" list="sisList" skip-form="true">
                            <field name="orderId"><default-field title="Order">
                                <link url="orderDetail" text="${orderId?:''}" link-type="anchor"/></default-field></field>
                            <field name="orderItemSeqId"><default-field title="Item"><display/></default-field></field>

                            <field name="quantity"><default-field><display/></default-field></field>
                            <field name="quantityNotHandled"><default-field><display/></default-field></field>

                            <field name="invoiceId"><default-field title="Invoice">
                                <link url="editInvoice" text="${invoiceId?:''}" link-type="anchor"/></default-field></field>
                            <field name="invoiceItemSeqId"><default-field title="Item"><display/></default-field></field>
                        </form-list>
                        <form-list name="ItemAssetReceiptList" list="assetReceiptList" skip-form="true">
                            <row-actions>
                                <entity-find-one entity-name="mantle.facility.FacilityLocation" value-field="facLoc"/>
                            </row-actions>

                            <field name="statusId"><default-field title="Status">
                                <display-entity entity-name="moqui.basic.StatusItem"/></default-field></field>

                            <field name="receivedDate"><default-field title="Received Date"><display/></default-field></field>
                            <field name="quantityOnHandTotal" align="right"><default-field title="QOH"><display/></default-field></field>
                            <field name="quantityAccepted" align="right"><default-field title="Accepted"><display/></default-field></field>
                            <field name="quantityRejected" align="right"><default-field title="Rejected"><display/></default-field></field>

                            <field name="assetId"><default-field title="Asset"><link url="assetDetail" text="${assetId}" link-type="anchor"/></default-field></field>
                            <!-- TODO: add lotId with link to lot detail -->

                            <field name="orderId"><default-field title="Order"><link url="orderDetail" text="${orderId}" link-type="anchor"/></default-field></field>
                            <field name="orderItemSeqId"><default-field title="Item"><display/></default-field></field>
                            <field name="locationSeqId"><default-field title="Stored At">
                                <display text="FacilityLocationNameTemplate" text-map="facLoc?:[:]"/></default-field></field>
                            <field name="lotId"><default-field title="Lot">
                                <display-entity entity-name="mantle.product.asset.LotAndMfgParty" text="LotNameTemplate"/></default-field></field>
                            
                            <field name="updateDialog"><header-field title=""/>
                                <conditional-field condition="shipment.statusId == 'ShipInput'">
                                    <dynamic-dialog id="UpdateAssetCntr" button-text="Update" transition="UpdateItemAsset">
                                        <parameter name="shipmentId"/><parameter name="assetId"/>
                                        <parameter name="statusId" value="AstIncoming"/></dynamic-dialog>
                                </conditional-field>
                                <conditional-field condition="statusId == 'AstIncoming'">
                                    <dynamic-dialog id="UpdateAssetCntr" button-text="Receive" transition="UpdateItemAsset">
                                        <parameter name="shipmentId"/><parameter name="assetId"/>
                                        <parameter name="statusId" value="AstAvailable"/></dynamic-dialog>
                                </conditional-field>
                                <default-field>
                                    <dynamic-dialog id="UpdateAssetCntr" button-text="Update" transition="UpdateItemAsset">
                                        <parameter name="shipmentId"/><parameter name="assetId"/>
                                        <parameter name="statusId" value="AstAvailable"/></dynamic-dialog>
                                </default-field>
                            </field>
                        </form-list>
                    </widgets><fail-widgets>
                        <form-list name="ItemSourceIssuanceList" list="sisList" transition="packItemSource">
                            <row-actions>
                                <entity-find entity-name="mantle.product.issuance.AssetReservation" list="existingResList">
                                    <econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/></entity-find>
                            </row-actions>
                            <field name="shipmentId"><default-field><hidden/></default-field></field>
                            <field name="shipmentItemSourceId"><default-field><hidden/></default-field></field>
                            <field name="orderId"><default-field title="Order">
                                <link url="orderDetail" text="${orderId?:''}" link-type="anchor"/></default-field></field>
                            <field name="orderItemSeqId"><default-field title="Item"><display/></default-field></field>

                            <field name="quantitySis" from="quantity">
                                <default-field title="Quantity"><display/></default-field></field>
                            <field name="quantityNotHandled"><default-field><display/></default-field></field>

                            <field name="invoiceId"><default-field title="Invoice">
                                <link url="editInvoice" text="${invoiceId?:''}" link-type="anchor"/></default-field></field>
                            <field name="invoiceItemSeqId"><default-field title="Item"><display/></default-field></field>

                            <field name="assetReservations">
                                <conditional-field condition="existingResList">
                                    <section-iterate name="ReservationInfoSection" list="existingResList" entry="existingRes"><widgets><container>
                                        <label text="Res: ${ec.l10n.format(existingRes.quantity, null)}, Not Avail: ${ec.l10n.format(existingRes.quantityNotAvailable, null)}, Not Issued: ${ec.l10n.format(existingRes.quantityNotIssued, null)}" type="span"/>
                                        <link url="assetDetail" text="Asset ${existingRes.assetId}" parameter-map="[assetId:existingRes.assetId]" link-type="anchor"/>
                                    </container></widgets></section-iterate>
                                </conditional-field>
                                <default-field><display text=" "/></default-field>
                            </field>

                            <field name="shipmentPackageSeqId">
                                <conditional-field condition="allowPack &amp;&amp; quantityNotHandled &gt; 0" title="Package"><drop-down>
                                    <option key="" text="New Package"/>
                                    <list-options list="shipmentPackageList" key="${shipmentPackageSeqId}" text="${shipmentPackageSeqId}"/>
                                </drop-down></conditional-field>
                                <default-field title="Package"><display text=" "/></default-field>
                            </field>
                            <field name="quantity" from="quantityNotHandled">
                                <conditional-field condition="allowPack &amp;&amp; quantityNotHandled &gt; 0" title="Pack Quantity">
                                    <text-line size="6"/></conditional-field>
                                <default-field title="Pack Quantity"><display text=" "/></default-field>
                            </field>
                            <field name="packButton">
                                <conditional-field condition="allowPack &amp;&amp; quantityNotHandled &gt; 0" title="Pack">
                                    <submit/></conditional-field>
                                <default-field title=""><display text=" "/></default-field>
                            </field>
                        </form-list>
                        <form-list name="ItemAssetIssuanceList" list="assetIssuanceList" skip-form="true">
                            <row-actions>
                                <entity-find-one entity-name="mantle.facility.FacilityLocation" value-field="facLoc"/>
                                <entity-find-one entity-name="mantle.product.issuance.AssetReservation" value-field="res"/>
                            </row-actions>
                            <field name="issuedDate"><default-field title="Issued Date"><display/></default-field></field>
                            <field name="quantity"><default-field title="Quantity"><display/></default-field></field>

                            <field name="assetId"><default-field><link url="assetDetail" text="${assetId}" link-type="anchor"/></default-field></field>
                            <field name="assetReservationId">
                                <conditional-field condition="res">
                                    <display text="${assetReservationId} - Res: ${ec.l10n.format(res.quantity, null)}, Not Avail: ${ec.l10n.format(res.quantityNotAvailable, null)}, Not Issued: ${ec.l10n.format(res.quantityNotIssued, null)}"/>
                                </conditional-field>
                                <default-field title="Reservation"><display/></default-field>
                            </field>

                            <field name="orderId"><default-field title="Order"><link url="orderDetail" text="${orderId}" link-type="anchor"/></default-field></field>
                            <field name="orderItemSeqId"><default-field title="Item"><display/></default-field></field>
                            <field name="locationSeqId"><default-field title="Was Stored At">
                                <display text="FacilityLocationNameTemplate" text-map="facLoc?:[:]"/></default-field></field>
                            <field name="lotId"><default-field title="Lot">
                                <display-entity entity-name="mantle.product.asset.LotAndMfgParty" text="LotNameTemplate"/></default-field></field>
                        </form-list>
                    </fail-widgets></section>
                </box-body-nopad></container-box>
            </widgets></section-iterate>
        </box-body></container-box>

        <!-- Packages -->
        <section name="ShipmentPackageSection"><widgets>
            <container-box><box-header><label text="Packages" type="h5"/></box-header><box-toolbar>
                <link url="createShipmentAutoPackages" text="Auto Packages" condition="shippingGatewayConfig?.getAutoPackageInfoName"
                    parameter-map="[resetExisting:true]" confirmation="Remove existing packages and create new based on auto-package data?"/>
                <link url="createPackage" text="Add Package"/>
            </box-toolbar><box-body>
                <section-iterate name="PackageListSection" list="shipmentPackageList" entry="shipmentPackage"><actions>
                    <set field="shipmentBoxType" from="shipmentPackage.boxType"/>
                    <set field="weightUom" from="shipmentPackage.weightUom"/>
                    <set field="shipmentPackageContentList" from="shipmentPackage.contents"/>
                    <set field="packageRouteSeg" from="packageRouteSegList.find({ it.shipmentPackageSeqId == shipmentPackage.shipmentPackageSeqId &amp;&amp; it.shipmentRouteSegmentSeqId == firstRouteSegment.shipmentRouteSegmentSeqId })"/>
                    <set field="trackingStatusEnum" from="packageRouteSeg?.trackingStatusEnum"/>
                    <script>packageAndRouteSeg = new HashMap(shipmentPackage); packageAndRouteSeg.putAll(packageRouteSeg)</script>
                </actions><widgets>
                    <container-box><box-header><label text="Package ${shipmentPackage.shipmentPackageSeqId}" type="h5"/></box-header><box-toolbar>
                        <container-dialog id="UpdatePackageDialog" button-text="Update Package">
                            <form-single name="UpdatePackageForm" map="packageAndRouteSeg" transition="updatePackageAndRouteSeg">
                                <field name="shipmentId"><default-field><hidden/></default-field></field>
                                <field name="shipmentPackageSeqId"><default-field><hidden/></default-field></field>
                                <field name="shipmentRouteSegmentSeqId"><default-field><hidden/></default-field></field>

                                <field name="shipmentBoxTypeId"><default-field title="Box Type">
                                    <drop-down allow-empty="true">
                                        <entity-options key="${shipmentBoxTypeId}" text="${description}">
                                            <entity-find entity-name="mantle.shipment.ShipmentBoxType">
                                                <order-by field-name="description"/></entity-find></entity-options>
                                    </drop-down>
                                </default-field></field>
                                <field name="weight"><default-field><text-line size="8"/></default-field></field>
                                <field name="weightUomId"><default-field title="Weight UOM">
                                    <drop-down allow-empty="true" no-current-selected-key="WT_lb">
                                        <entity-options key="${uomId}" text="${description}">
                                            <entity-find entity-name="moqui.basic.Uom">
                                                <econdition field-name="uomTypeEnumId" value="UT_WEIGHT_MEASURE"/>
                                                <order-by field-name="description"/></entity-find></entity-options>
                                    </drop-down>
                                </default-field></field>
                                <field name="trackingCode"><default-field><text-line size="30"/></default-field></field>
                                <!-- <field name="boxNumber"><default-field><text-line size="8"/></default-field></field> -->
                                <field name="estimatedAmount"><default-field title="Est. Cost"><text-line size="10"/></default-field></field>

                                <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>

                        <link url="trackShipmentLabels" text="Track" condition="shippingGatewayConfigId &amp;&amp; packageRouteSeg?.gatewayLabelId"
                                parameter-map="[shipmentId:shipmentId, shipmentPackageSeqId:shipmentPackage.shipmentPackageSeqId,
                                    shipmentRouteSegmentSeqId:packageRouteSeg.shipmentRouteSegmentSeqId]"/>
                        <link url="${packageRouteSeg.trackingUrl}" text="Carrier Track" url-type="plain" target-window="_blank" condition="packageRouteSeg?.trackingUrl"/>
                        <link url="${packageRouteSeg.labelUrl}" text="Download/Print Label" url-type="plain" target-window="_blank" condition="packageRouteSeg?.labelUrl"/>
                        <link url="refundShipmentLabels" text="Refund Label"
                                confirmation="Request refund? If package has not yet shipped a refund will be processed and label will not be valid for shipping."
                                condition="shippingGatewayConfigId &amp;&amp; packageRouteSeg?.gatewayLabelId &amp;&amp; !packageRouteSeg?.gatewayRefundId"
                                parameter-map="[shipmentId:shipmentId, shipmentPackageSeqId:shipmentPackage.shipmentPackageSeqId,
                                    shipmentRouteSegmentSeqId:packageRouteSeg.shipmentRouteSegmentSeqId]"/>
                        <link url="removeShipmentLabelInfo" text="Clear Label Info"
                                confirmation="Clear label data? This will allow getting a new label, and system keeps a history of label IDs, but otherwise current label will no longer be tracked. Use only when there are errors, etc with the label."
                                condition="shippingGatewayConfigId &amp;&amp; packageRouteSeg?.gatewayLabelId"
                                parameter-map="[shipmentId:shipmentId, shipmentPackageSeqId:shipmentPackage.shipmentPackageSeqId,
                                    shipmentRouteSegmentSeqId:packageRouteSeg.shipmentRouteSegmentSeqId]"/>
                    </box-toolbar><box-body>
                        <container-row>
                            <row-col sm="1"><label text="Status" type="strong"/></row-col>
                            <row-col sm="1"><label text="${trackingStatusEnum?.description?:'N/A'}"/></row-col>
                            <row-col sm="1"><label text="Box Type" type="strong"/></row-col>
                            <row-col sm="2"><label text="${shipmentBoxType?.description?:'N/A'}" style="text-info"/></row-col>
                            <row-col sm="1"><label text="Weight" type="strong"/></row-col>
                            <row-col sm="2"><label text="${ec.l10n.format(shipmentPackage.weight, null)?:'N/A'} ${weightUom?.description?:''}" style="text-info"/></row-col>
                            <row-col sm="1"><label text="Tracking" type="strong"/></row-col>
                            <row-col sm="3"><label text="${packageRouteSeg?.trackingCode?:'N/A'}"/></row-col>
                        </container-row>
                        <container-row>
                            <row-col sm="1"><label text="Gateway" type="strong"/></row-col>
                            <row-col sm="2"><label text="${packageRouteSeg?.gatewayStatus?:'N/A'}"/></row-col>
                            <row-col sm="1"><label text="Message" type="strong"/></row-col>
                            <row-col sm="8"><label text="${packageRouteSeg?.gatewayMessage?:'N/A'}"/></row-col>
                        </container-row>
                        <container-row>
                            <row-col sm="1"><label text="Label ID" type="strong"/></row-col>
                            <row-col sm="3"><label text="${packageRouteSeg?.gatewayLabelId?:'N/A'}"/></row-col>
                            <row-col sm="1"><label text="Rate ID" type="strong"/></row-col>
                            <row-col sm="3"><label text="${packageRouteSeg?.gatewayRateId?:'N/A'}"/></row-col>
                            <row-col sm="1"><label text="Amount" type="strong"/></row-col>
                            <row-col sm="3"><label text="${ec.l10n.format(packageRouteSeg?.estimatedAmount, '#,##0.00')}" style="text-success"/></row-col>
                        </container-row>
                        <section name="LabelRefundSection" condition="packageRouteSeg?.gatewayRefundId"><widgets>
                            <container-row>
                                <row-col sm="1"><label text="Refund" type="strong"/></row-col>
                                <row-col sm="1"><label text="${packageRouteSeg?.gatewayRefundStatus?:'N/A'}"/></row-col>
                                <row-col sm="1"><label text="Refund ID" type="strong"/></row-col>
                                <row-col sm="3"><label text="${packageRouteSeg?.gatewayRefundId?:'N/A'}"/></row-col>
                            </container-row>
                        </widgets></section>
                    </box-body><box-body-nopad>
                        <form-list name="ShipmentPackageContentList" list="shipmentPackageContentList" transition="updatePackageContent">
                            <field name="shipmentId"><default-field><hidden/></default-field></field>
                            <field name="shipmentPackageSeqId"><default-field><hidden/></default-field></field>
                            <field name="productId"><default-field title="Product">
                                <display-entity entity-name="mantle.product.Product" text="ProductNameTemplate"/>
                            </default-field></field>
                            <field name="quantity"><default-field><text-line size="6"/></default-field></field>
                            <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                        </form-list>
                    </box-body-nopad></container-box>
                </widgets></section-iterate>
            </box-body></container-box>
        </widgets></section>
    </widgets>
</screen>
