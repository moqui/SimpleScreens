<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        default-menu-title="Items" default-menu-index="2">

    <parameter name="shipmentId" required="true"/>
    <!-- FILTER PASS THROUGH -->
    <parameter name="filterProductId"/><parameter name="onlyRemaining"/>
    <parameter name="pageIndex"/>

    <transition name="shipmentDetail"><default-response url="//${appRoot}/Shipment/ShipmentDetail"/></transition>

    <transition name="orderDetail"><default-response url="//${appRoot}/Order/OrderDetail"/></transition>
    <transition name="editInvoice"><default-response url="//${appRoot}/Accounting/Invoice/EditInvoice"/></transition>
    <transition name="assetDetail"><default-response url="//${appRoot}/Asset/AssetDetail"/></transition>

    <transition name="updateItem"><service-call name="mantle.shipment.ShipmentServices.update#ShipmentItem"/>
        <default-response url="."/></transition>
    <transition name="packShipmentProduct"><service-call name="mantle.shipment.ShipmentServices.pack#ShipmentProduct"/>
        <default-response url="."/></transition>
    <transition name="packItemSource"><service-call name="mantle.shipment.ShipmentServices.pack#ShipmentItemSource"/>
        <default-response url="."/></transition>
    <transition name="unpackItemIssuance"><service-call name="mantle.shipment.ShipmentServices.unpack#ShipmentItemIssuance"/>
        <default-response url="."/></transition>

    <transition name="addItemToPackage"><service-call name="mantle.shipment.ShipmentServices.add#ItemToPackage"/>
        <default-response url="."/></transition>

    <transition-include name="getAssetList" location="component://SimpleScreens/template/product/ProductTransitions.xml"/>
    <transition-include name="getPackageWeight" location="component://SimpleScreens/template/shipment/ShipmentTransitions.xml"/>
    <transition-include name="getShipmentLabel" location="component://SimpleScreens/template/shipment/ShipmentTransitions.xml"/>

    <actions>
        <service-call name="mantle.shipment.ShipmentInfoServices.get#ShipmentDisplayInfo" in-map="[shipmentId:shipmentId]" out-map="context"/>
        <if condition="!isOutgoing &amp;&amp; !isTransfer"><return error="true" message="Shipment ${shipmentId} is not an outgoing or transfer shipment"/></if>
        <set field="statusPrePacked" from="shipment.statusId in ['ShipInput', 'ShipScheduled', 'ShipPicked']"/>

        <!-- maybe improve; session maintained active (or first package with no box/weight?) -->
        <set field="activePackage" from="shipmentPackageList?.find({ it.weight == null || it.shipmentBoxTypeId == null })"/>
        <set field="activePackageSeqId" from="activePackage?.shipmentPackageSeqId"/>
        <if condition="activePackage != null">
            <set field="activePackageRouteSeg" from="packageRouteSegList.find({ it.shipmentPackageSeqId == activePackage.shipmentPackageSeqId &amp;&amp; it.shipmentRouteSegmentSeqId == firstRouteSegment.shipmentRouteSegmentSeqId })"/>
            <script>activePackageAndRouteSeg = new HashMap(activePackage); activePackageAndRouteSeg.putAll(activePackageRouteSeg)</script>
        </if>

        <!-- get all products for filter form -->
        <set field="allProductIds" from="shipmentItemDetailList*.productId"/>
        <entity-find entity-name="mantle.product.Product" list="allProductList">
            <econdition field-name="productId" operator="in" from="allProductIds"/>
            <order-by field-name="pseudoId"/>
        </entity-find>

        <if condition="filterProductId">
            <filter-map-list list="shipmentItemDetailList"><field-map field-name="productId" from="filterProductId"/></filter-map-list>
        </if>
        <if condition="onlyRemaining == 'Y'">
            <set field="tempItemDetailList" from="new ArrayList()"/>
            <iterate list="shipmentItemDetailList" entry="sid">
                <if condition="isOutgoing || isTransfer">
                    <if condition="(sid.quantity - (sid.quantityTotal ?: 0.0)) &gt; 0.0">
                        <script>tempItemDetailList.add(sid)</script><continue/></if>
                </if>
                <if condition="isIncoming || isTransfer">
                    <if condition="(sid.quantity - (sid.quantityAcceptedTotal ?: 0.0) - (sid.quantityRejectedTotal ?: 0.0)) &gt; 0.0">
                        <script>tempItemDetailList.add(sid)</script><continue/></if>
                </if>
            </iterate>
            <set field="shipmentItemDetailList" from="tempItemDetailList"/>
        </if>

        <set field="pageSize" from="pageSize ?: '10'"/>
    </actions>
    <widgets>
        <container style="text-strong">
            <label text="Pack Shipment - Items"/>
            <link url="shipmentDetail" text="${shipmentId}" link-type="anchor"/>
            <label text=" (${statusItem.description})" condition="statusItem"/>
        </container>

        <form-single name="ItemsOptionsForm" transition="." pass-through-parameters="true">
            <field name="filterProductId"><default-field title="Product"><drop-down allow-empty="true">
                <list-options list="allProductList" key="${productId}" text="ProductNameTemplate"/>
                <!-- <dynamic-options transition="getProductList" server-search="true" min-length="0"/> --></drop-down></default-field></field>
            <field name="onlyRemaining"><default-field><radio no-current-selected-key="N"><option key="Y"/><option key="N"/></radio></default-field></field>
            <field name="submitBtn"><default-field title="Filter"><submit/></default-field></field>
            <field-layout><field-row-big><field-ref name="filterProductId"/><field-ref name="onlyRemaining"/>
                <field-ref name="submitBtn"/></field-row-big></field-layout>
            <!-- TODO: when adding fields here make sure to add to sections near "FILTER PASS THROUGH" comments in this screen and in ItemReserve.xml, ReceiveItem.xml, UpdateItemAsset.xml -->
        </form-single>

        <!-- product/item list -->
        <!-- pack/issue form -->
        <!-- unpack button -->
        <section-iterate name="ShipmentItemsSection" list="shipmentItemDetailList" entry="sid" paginate="true"><actions>
            <if condition="isOutgoing || isTransfer">
                <set field="quantityPackRemaining" from="sid.quantity - (sid.quantityTotal ?: 0)"/>
                <entity-find entity-name="mantle.product.issuance.AssetAndIssuance" list="assetIssuanceList">
                    <econdition field-name="shipmentId"/><econdition field-name="productId" from="sid.productId"/></entity-find>
            </if>
            <set field="allowPack" from="(isOutgoing || isTransfer) &amp;&amp; shipment.statusId in ['ShipInput', 'ShipScheduled', 'ShipPicked'] &amp;&amp; quantityPackRemaining &gt; 0"/>

            <entity-find-one entity-name="moqui.basic.Uom" value-field="productUom">
                <field-map field-name="uomId" from="sid.amountUomId"/></entity-find-one>
            <entity-find entity-name="mantle.shipment.ShipmentItemSource" list="sisList">
                <econdition field-name="shipmentId"/><econdition field-name="productId" from="sid.productId"/></entity-find>
            <entity-find-one entity-name="mantle.product.Product" value-field="product">
                <field-map field-name="productId" from="sid.productId"/></entity-find-one>

            <entity-find entity-name="mantle.shipment.ShipmentPackageContent" list="packageContentList">
                <econdition field-name="shipmentId"/><econdition field-name="productId" from="sid.productId"/></entity-find>
            <set field="packageContentTotal" from="(packageContentList*.quantity).sum() ?: 0.0"/>
            <set field="quantityNotInPackage" from="((BigDecimal) sid.quantity ?: 0.0) - packageContentTotal"/>
        </actions><widgets>
            <container-box><box-header title="${ec.resource.expand('ProductNameTemplate', '', sid)} (Qty ${ec.l10n.format(sid.quantity ?: 0, '#.##')})"/><box-toolbar>
                <section name="PackItemSection" condition="allowPack"><widgets>
                    <container-dialog id="PackItemContainer" button-text="Pack/Issue Item" type="success">
                        <form-single name="PackItemForm" transition="packShipmentProduct" map="sid" pass-through-parameters="true">
                            <field name="shipmentId"><default-field><hidden/></default-field></field>
                            <field name="productId"><default-field title="Product">
                                <display-entity entity-name="mantle.product.Product" text="ProductNameTemplate"/></default-field></field>
                            <field name="shipmentPackageSeqId" from="activePackageSeqId"><default-field title="Package##Shipment"><drop-down>
                                <option key="" text="New Package"/>
                                <list-options list="shipmentPackageList" key="${shipmentPackageSeqId}" text="${shipmentPackageSeqId}"/>
                            </drop-down></default-field></field>
                            <field name="quantity" from="quantityPackRemaining">
                                <default-field><text-line size="8"/></default-field></field>
                            <field name="packDate" from="shipment.estimatedShipDate ?: ec.user.nowTimestamp">
                                <default-field title="Pack Date"><date-time/></default-field></field>
                            <field name="assetId"><default-field title="Asset">
                                <drop-down><dynamic-options transition="getAssetList" server-search="true" min-length="0"
                                        parameter-map="[facilityId:firstRouteSegment.originFacilityId, productId:productId, assetTypeEnumId:null, excludeZeroQoh:'true']"/></drop-down>
                            </default-field></field>
                            <field name="submitButton"><default-field title="Pack Quantity"><submit/></default-field></field>
                        </form-single>
                    </container-dialog>
                </widgets></section>
            </box-toolbar><box-body>
                <label condition="isOutgoing || isTransfer" type="p" style="text-strong"
                        text="Packed/Issued: ${ec.l10n.format(sid.quantityTotal ?: 0, '#.##')}, Remaining: ${ec.l10n.format(quantityPackRemaining, '#.##')}  (Unit: ${productUom?.description ?: 'N/A'})"/>
                <container-row>
                    <row-col lg="5">
                        <section name="ShipItemUpdateSection" condition="allowUpdate"><widgets>
                            <form-single name="UpdateItemForm" transition="updateItem" map="sid" pass-through-parameters="true">
                                <field name="shipmentId"><default-field><hidden/></default-field></field>
                                <field name="productId"><default-field><hidden/></default-field></field>
                                <field name="quantity"><default-field title=""><text-line size="6"/></default-field></field>
                                <field name="submitButton"><default-field title="Update Quantity"><submit/></default-field></field>
                                <field-layout><field-row-big><field-ref name="quantity"/><field-ref name="submitButton"/></field-row-big></field-layout>
                            </form-single>
                        </widgets></section>
                    </row-col>
                    <row-col lg="7">
                        <section name="ShipItemPackageSection" condition="quantityNotInPackage"><widgets>
                            <form-single name="AddItemToPackageForm" transition="addItemToPackage" map="sid" pass-through-parameters="true">
                                <field name="shipmentId"><default-field><hidden/></default-field></field>
                                <field name="productId"><default-field><hidden/></default-field></field>
                                <field name="shipmentPackageSeqId"><default-field title=""><drop-down>
                                    <option key="" text="New"/>
                                    <list-options list="shipmentPackageList" key="${shipmentPackageSeqId}" text="${shipmentPackageSeqId}"/>
                                </drop-down></default-field></field>
                                <field name="quantity" from="quantityNotInPackage"><default-field title="">
                                    <text-line size="6"/></default-field></field>
                                <field name="submitButton"><default-field title="Add to Package"><submit/></default-field></field>
                                <field-layout><field-row-big><field-ref name="shipmentPackageSeqId"/>
                                    <field-ref name="quantity"/><field-ref name="submitButton"/></field-row-big></field-layout>
                            </form-single>
                        </widgets></section>
                    </row-col>
                </container-row>
            </box-body><box-body-nopad>
                <!-- Pack and Issuance -->
                <section name="ItemAssetPackSection" condition="isOutgoing || isTransfer"><widgets>
                    <form-list name="ItemSourceIssuanceList" list="sisList" transition="packItemSource">
                        <row-actions>
                            <entity-find entity-name="mantle.product.issuance.AssetReservation" list="existingResList">
                                <econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/></entity-find>
                            <set field="resPackForm" from="allowPack &amp;&amp; quantityNotHandled &gt; 0.0 &amp;&amp; existingResList"/>
                        </row-actions>
                        <field name="shipmentId"><default-field><hidden/></default-field></field>
                        <field name="shipmentItemSourceId"><default-field><hidden/></default-field></field>
                        <field name="orderId"><default-field title="Order Item">
                            <link url="orderDetail" text="${orderId?:''}:${orderItemSeqId?:''}" link-type="anchor" condition="orderId"/></default-field></field>

                        <field name="quantitySis" from="quantity"><default-field title="Qty"><display/></default-field></field>
                        <field name="quantityNotHandled"><default-field title="Rem"><display/></default-field></field>

                        <!-- <field name="invoiceId"><default-field title="Invoice Item">
                            <link url="editInvoice" text="${invoiceId?:''}:${invoiceItemSeqId?:''}" link-type="anchor" condition="invoiceId"/></default-field></field> -->

                        <field name="assetReservations">
                            <conditional-field condition="existingResList">
                                <section-iterate name="ReservationInfoSection" list="existingResList" entry="existingRes"><actions>
                                    <entity-find-one entity-name="mantle.product.asset.AssetLotAndMfgParty" value-field="assetLot">
                                        <field-map field-name="assetId" from="existingRes.assetId"/></entity-find-one>
                                </actions><widgets>
                                    <container>
                                        <label text="Res: ${ec.l10n.format(existingRes.quantity, null)}, Not Avail: ${ec.l10n.format(existingRes.quantityNotAvailable, null)}, Not Issued: ${ec.l10n.format(existingRes.quantityNotIssued, null)}" type="span"/>
                                        <link url="assetDetail" text="Asset ${existingRes.assetId}" parameter-map="[assetId:existingRes.assetId]" link-type="anchor"/>
                                    </container>
                                    <label text="LotNameTemplate" text-map="assetLot" condition="assetLot?.lotId"/>
                                </widgets></section-iterate>
                            </conditional-field>
                            <default-field><display text=" "/></default-field>
                        </field>
                        <field name="shipmentPackageSeqId" from="activePackageSeqId">
                            <conditional-field condition="resPackForm" title="Package##Shipment"><drop-down>
                                <option key="" text="New"/>
                                <list-options list="shipmentPackageList" key="${shipmentPackageSeqId}" text="${shipmentPackageSeqId}"/>
                            </drop-down></conditional-field>
                            <default-field title="Package##Shipment"><display text=" "/></default-field>
                        </field>
                        <field name="quantity" from="quantityNotHandled">
                            <conditional-field condition="resPackForm" title="Pack Qty"><text-line size="3"/></conditional-field>
                            <default-field title="Pack Qty"><display text=" "/></default-field>
                        </field>
                        <field name="packButton">
                            <conditional-field condition="resPackForm" title="Pack"><submit/></conditional-field>
                            <default-field title=""><display text=" "/></default-field>
                        </field>
                    </form-list>
                    <form-list name="ItemAssetIssuanceList" list="assetIssuanceList" skip-form="true">
                        <row-actions>
                            <entity-find-one entity-name="mantle.facility.FacilityLocation" value-field="facLoc"/>
                            <entity-find-one entity-name="mantle.product.issuance.AssetReservation" value-field="res"/>
                        </row-actions>

                        <field name="quantity"><default-field title="Issued"><display/></default-field></field>
                        <field name="issuedDate"><default-field title="Issued Date"><display/></default-field></field>

                        <field name="orderId"><default-field title="Order Item">
                            <link url="orderDetail" text="${orderId?:''}:${orderItemSeqId?:''}" link-type="anchor"/></default-field></field>
                        <field name="assetId"><default-field title="Asset">
                            <link url="assetDetail" text="${assetId}" link-type="anchor"/></default-field></field>
                        <field name="assetReservationId">
                            <conditional-field condition="res">
                                <display text="${assetReservationId} - Res: ${ec.l10n.format(res.quantity, null)}, Not Avail: ${ec.l10n.format(res.quantityNotAvailable, null)}, Not Issued: ${ec.l10n.format(res.quantityNotIssued, null)}"/>
                            </conditional-field>
                            <default-field title="Reservation"><display/></default-field>
                        </field>
                        <field name="lotId"><default-field title="Lot">
                            <display-entity entity-name="mantle.product.asset.LotAndMfgParty" text="LotNameTemplate"/></default-field></field>

                        <field name="locationSeqId"><default-field title="Was Stored At">
                            <display text="FacilityLocationNameTemplate" text-map="facLoc?:[:]"/></default-field></field>
                        <field name="unpackLink"><default-field title=""><link url="unpackItemIssuance" text="Unpack"
                                parameter-map="[shipmentId:shipmentId, assetIssuanceId:assetIssuanceId]"
                                condition="!invoiceId &amp;&amp; quantity"
                                confirmation="Are you sure? Only do this when necessary to avoid processing a return to receive the item back into inventory."/>
                        </default-field></field>

                        <form-list-column><field-ref name="quantity"/><!-- <field-ref name="issuedDate"/> --></form-list-column>
                        <form-list-column><field-ref name="orderId"/><field-ref name="assetId"/></form-list-column>
                        <form-list-column><field-ref name="assetReservationId"/><field-ref name="lotId"/></form-list-column>
                        <form-list-column><field-ref name="locationSeqId"/></form-list-column>
                        <form-list-column><field-ref name="unpackLink"/></form-list-column>
                    </form-list>
                </widgets></section>
            </box-body-nopad></container-box>
        </widgets></section-iterate>
    </widgets>
</screen>
