<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a 
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-3.xsd"
        default-menu-title="Order Detail" default-menu-index="1">

    <parameter name="orderId" required="true"/>

    <transition name="editParty"><default-response url="//${appRoot}/Party/EditParty"/></transition>
    <transition name="editSupplier"><default-response url="//${appRoot}/Supplier/EditSupplier"/></transition>
    <transition name="editCustomer"><default-response url="//${appRoot}/Customer/EditCustomer"/></transition>

    <transition name="editFacility"><default-response url="//${appRoot}/Facility/EditFacility"/></transition>
    <transition name="editProduct"><default-response url="//${appRoot}/Product/EditProduct"/></transition>
    <transition name="assetDetail"><default-response url="//${appRoot}/Asset/AssetDetail"/></transition>

    <transition name="editInvoice"><default-response url="//${appRoot}/Accounting/Invoice/EditInvoice"/></transition>
    <transition name="editPayment"><default-response url="//${appRoot}/Accounting/Payment/EditPayment"/></transition>
    <transition name="editPaymentMethod"><default-response url="//${appRoot}/Party/PaymentMethod/EditPaymentMethod"/></transition>

    <transition name="systemMessageDetail"><default-response url="//apps/system/SystemMessage/Message/SystemMessageDetail"/></transition>

    <transition name="updateOrderHeader"><service-call name="mantle.order.OrderServices.update#OrderHeader"/>
        <default-response url="."/></transition>
    <transition name="updateOrderRecur"><service-call name="mantle.order.OrderServices.update#OrderRecur"/>
        <default-response url="."/></transition>

    <transition name="requestOrder"><service-call name="mantle.order.OrderServices.update#OrderStatus" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, statusId:'OrderRequested']"/>
        <default-response url="."/></transition>
    <transition name="proposeOrder"><service-call name="mantle.order.OrderServices.update#OrderStatus" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, statusId:'OrderProposed']"/>
        <default-response url="."/></transition>
    <!-- TODO: consider using cancel#Order service with parameter to reject instead of cancel, but rejected should always happen before Approved so nothing should be shipped, unless the order goes backward through statuses... -->
    <transition name="rejectOrder"><service-call name="mantle.order.OrderServices.update#OrderStatus" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, statusId:'OrderRejected']"/>
        <default-response url="."/></transition>
    <transition name="placeOrder"><service-call name="mantle.order.OrderServices.place#Order" in-map="context + [requireInventory:false]"/>
        <default-response url="."/></transition>
    <transition name="approveOrder"><service-call name="mantle.order.OrderServices.approve#Order"/>
        <default-response url="."/></transition>
    <transition name="sendOrder"><service-call name="mantle.order.OrderServices.update#OrderStatus" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, statusId:'OrderSent']"/>
        <default-response url="."/></transition>
    <transition name="holdOrder"><service-call name="mantle.order.OrderServices.update#OrderStatus" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, statusId:'OrderHold']"/>
        <default-response url="."/></transition>

    <transition name="completeOrderPart"><service-call name="mantle.order.OrderServices.complete#OrderPart"/>
        <default-response url="."/></transition>
    <transition name="cancelOrder"><service-call name="mantle.order.OrderServices.cancel#Order"/>
        <default-response url="."/></transition>
    <transition name="cancelOrderPart"><service-call name="mantle.order.OrderServices.cancel#OrderPart"/>
        <default-response url="."/></transition>
    <transition name="cancelOrderItem"><service-call name="mantle.order.OrderServices.cancel#OrderItem"/>
        <default-response url="."/></transition>

    <transition name="cloneOrder"><service-call name="mantle.order.OrderServices.clone#Order"/>
        <default-response url="."/></transition>

    <transition name="addOrderPromoCode"><service-call name="mantle.product.PromotionServices.add#OrderPromoCode"/>
        <default-response url="."/></transition>
    <transition name="removeOrderPromoCode"><service-call name="mantle.product.PromotionServices.remove#OrderPromoCode"/>
        <default-response url="."/></transition>
    <transition name="sendOrderStoreEmail"><service-call name="mantle.order.OrderInfoServices.send#OrderStoreEmail"/>
        <default-response url="."/></transition>
    <transition name="sendEmailMessage"><service-call name="org.moqui.impl.EmailServices.send#EmailMessage"/>
        <default-response url="."/></transition>

    <transition name="recalcOrderPartItemAmounts"><service-call name="mantle.order.OrderServices.recalc#OrderPartItemAmounts"/>
        <default-response url="."/></transition>

    <transition name="invoiceOrderPart"><service-call name="mantle.account.InvoiceServices.create#EntireOrderPartInvoice"/>
        <default-response url="."/></transition>
    <transition name="shipOrderPart"><service-call name="mantle.shipment.ShipmentServices.create#OrderPartShipment"/>
        <default-response url="."/></transition>
    <transition name="addOrderPartToShipment"><service-call name="mantle.shipment.ShipmentServices.add#OrderPartToShipment"/>
        <default-response url="."/></transition>
    <transition name="shipmentDetail"><default-response url="//${appRoot}/Shipment/ShipmentDetail"/></transition>

    <transition name="createNote"><service-call name="create#mantle.order.OrderNote"/><default-response url="."/></transition>
    <transition name="updateNote"><service-call name="update#mantle.order.OrderNote"/><default-response url="."/></transition>

    <transition name="createContent"><service-call name="mantle.order.OrderServices.create#OrderContent"/>
        <default-response url="."/></transition>
    <transition name="updateContent"><service-call name="mantle.order.OrderServices.update#OrderContent"/>
        <default-response url="."/></transition>
    <transition name="downloadContent" read-only="true"><parameter name="orderContentId"/>
        <actions><entity-find-one entity-name="mantle.order.OrderContent" value-field="orderContent"/>
            <script>ec.web.sendResourceResponse(orderContent.contentLocation)</script></actions>
        <default-response type="none"/>
    </transition>

    <transition name="setOrderBillingShippingInfo"><service-call name="mantle.order.OrderServices.set#OrderBillingShippingInfo"/>
        <default-response url="."/></transition>
    <transition name="validateAddress"><service-call name="mantle.shipment.CarrierServices.validate#PostalAddress"/>
        <default-response url="."/></transition>

    <transition name="createOrderPart"><service-call name="mantle.order.OrderServices.create#OrderPart"/>
        <default-response url="."/></transition>
    <transition name="updateOrderPart"><service-call name="mantle.order.OrderServices.update#OrderPart"/>
        <default-response url="."/></transition>

    <transition name="addOrderPartPayment"><service-call name="mantle.order.OrderServices.add#OrderPartPayment"/>
        <default-response url="."/></transition>
    <transition name="updatePayment"><service-call name="mantle.account.PaymentServices.update#Payment"/>
        <default-response url="."/></transition>
    <transition name="gatewayAuthorize"><service-call name="mantle.account.PaymentServices.authorize#SinglePayment"/>
        <default-response url="."/></transition>

    <transition name="createReturnFromOrder"><service-call name="mantle.order.ReturnServices.create#ReturnFromOrder"/>
        <default-response url="."/></transition>
    <transition name="editReturn"><default-response url="//${appRoot}/Return/EditReturn"/></transition>

    <transition name="createOrderPartParty"><service-call name="create#mantle.order.OrderPartParty"/>
        <default-response url="."/></transition>
    <transition name="deleteOrderPartParty"><service-call name="delete#mantle.order.OrderPartParty"/>
        <default-response url="."/></transition>

    <transition name="addProductItem"><service-call name="mantle.order.OrderServices.add#OrderProductQuantity"/>
        <default-response url="."/></transition>
    <transition name="createItem"><service-call name="mantle.order.OrderServices.create#OrderItem"/>
        <default-response url="."/></transition>
    <transition name="updateItem"><service-call name="mantle.order.OrderServices.update#OrderItem"/>
        <default-response url="."/></transition>
    <transition name="deleteItem"><service-call name="mantle.order.OrderServices.delete#OrderItem"/>
        <default-response url="."/></transition>

    <transition name="removeOrderItemReservations"><service-call name="mantle.product.AssetServices.remove#OrderItemReservations"/>
        <default-response url="."/></transition>

    <transition-include name="searchPartyList" location="component://SimpleScreens/template/party/PartyForms.xml"/>
    <transition-include name="getProductList" location="component://SimpleScreens/template/product/ProductTransitions.xml"/>
    <transition-include name="getProductPrice" location="component://SimpleScreens/template/product/ProductTransitions.xml"/>
    <transition-include name="getFacilityList" location="component://SimpleScreens/template/facility/FacilityTransitions.xml"/>

    <transition name="getShippingOptions"><parameter name="orderId"/><parameter name="orderPartSeqId"/><actions>
        <entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/>
        <service-call name="mantle.product.StoreServices.get#StoreShippingOptions" out-map="shipOptsOut"
                in-map="[productStoreId:orderHeader.productStoreId, orderId:orderId, orderPartSeqId:orderPartSeqId,
                            postalContactMechId:postalContactMechId, getRates:true]"/>
        <script>
            outList = []
            for (sop in shipOptsOut.shippingOptions) outList.add([value:"${sop.carrierPartyId}:${sop.shipmentMethodEnumId}".toString(),
                label:"${sop.description ? sop.description : (sop.carrierPartyId != '_NA_' ? (sop.carrierName + ' - ') : '') + sop.shipmentMethodDescription}${sop.shippingTotal != null ? ' ' + ec.l10n.formatCurrency(sop.shippingTotal, orderHeader.currencyUomId) : ''}".toString()])
            ec.web.sendJsonResponse(outList)
        </script>
    </actions><default-response type="none"/></transition>

    <transition name="EmailMessage" read-only="true"><parameter name="emailMessageId"/><actions>
        <entity-find-one entity-name="moqui.basic.email.EmailMessage" value-field="emailMessage"/>
        <script>ec.web.sendTextResponse(emailMessage?.body, "text/html", null)</script>
    </actions><default-response type="none"/></transition>
    <transition name="PrintOrder.pdf">
        <default-response url="${ec.web.getWebappRootUrl(false, null)}/fop/apps/${appRoot}/Order/PrintOrder" url-type="plain">
            <parameter name="renderMode" value="xsl-fo"/><parameter name="pageNoLimit" value="true"/>
            <parameter name="orderId"/><parameter name="filename" value="Order-${orderId}.pdf"/>
        </default-response>
    </transition>

    <transition name="setItemLimit"><actions><script>ec.user.setPreference('order.detail.item.limit', itemLimit)</script></actions>
        <default-response url="."/></transition>

    <subscreens>
        <subscreens-item name="UpdateContactInfo" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/UpdateContactInfo.xml"/>
        <subscreens-item name="UpdatePaymentMethodInfo" location="component://SimpleScreens/screen/SimpleScreens/Party/EditParty/UpdatePaymentMethodInfo.xml"/>
    </subscreens>
    <actions>
        <set field="defaultItemLimit" from="ec.user.getPreference('order.detail.item.limit') ?: '10'"/>
        <set field="itemLimit" from="itemLimit ?: defaultItemLimit"/>
        <service-call name="mantle.order.OrderInfoServices.get#OrderDisplayInfo" in-map="[orderId:orderId, itemLimit:(itemLimit as Integer)]" out-map="context"/>
        <set field="firstPartInfo" from="orderPartInfoList[0]"/>

        <set field="vendorRole" value="OrgInternal,Supplier,Vendor"/>
        <set field="customerRole" value="OrgInternal,Customer"/>
        <entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true">
            <econdition field-name="enumGroupEnumId" value="EngItemsProduct"/></entity-find>
        <set field="productItemTypes" from="productItemTypeEgms*.enumId"/>

        <if condition="orderHeader.statusId in ['OrderPlaced', 'OrderProcessing', 'OrderHold']">
            <service-call name="mantle.order.OrderInfoServices.check#OrderPreApprove" in-map="[orderId:orderId]" out-map="context"/></if>
    </actions>
    <widgets>
        <section name="OrderHeaderSection"><widgets>
            <container-row><row-col lg="6">
                <container-row><row-col sm="6">
                    <label text="Order #${orderId}" type="h4"/>
                </row-col><row-col sm="6">
                    <label text="Web Order (ecommerce)" condition="orderHeader?.salesChannelEnumId == 'ScWeb'" type="h4" style="text-success"/>
                </row-col></container-row>
                <label text="Recurring Order: ${recurCronDescription}" condition="recurCronDescription" type="h4" style="text-success"/>

                <section name="PlaceSection" condition="orderHeader.statusId in ['OrderOpen', 'OrderProposed', 'OrderBeingChanged', 'OrderHold']"><widgets>
                    <link url="placeOrder" text="Place" link-type="hidden-form" condition="!placeWarnings" style="btn-success"/>
                    <container-dialog id="PlaceOrderDialog" button-text="Place Warnings" condition="placeWarnings" type="success">
                        <section-iterate name="PlaceWarningsSection" list="placeWarnings" entry="placeWarning"><widgets>
                            <label text="${placeWarning}" type="p"/></widgets></section-iterate>
                        <link url="placeOrder" text="Place Order Anyway" link-type="hidden-form"/>
                    </container-dialog>
                </widgets></section>
                <section name="ApproveSection" condition="orderHeader.statusId in ['OrderPlaced', 'OrderProcessing', 'OrderHold']"><widgets>
                    <link url="approveOrder" text="Approve" link-type="hidden-form" style="btn-success"
                            condition="ec.user.hasPermission('ORDER_APPROVE') &amp;&amp; !approveWarnings"/>
                    <container-dialog id="ApproveOrderDialog" button-text="Approve Warnings" condition="approveWarnings" type="success">
                        <section-iterate name="ApproveWarningsSection" list="approveWarnings" entry="approveWarning"><widgets>
                            <label text="${approveWarning}" type="p"/></widgets></section-iterate>
                        <link url="approveOrder" text="Approve Order Anyway" link-type="hidden-form"
                                condition="ec.user.hasPermission('ORDER_APPROVE')"/>
                    </container-dialog>
                </widgets></section>

                <link url="placeOrder" text="Un-approve" link-type="hidden-form"
                        condition="orderHeader.statusId == 'OrderApproved'" confirmation="Un-approve order (change status back to Placed)?"/>
                <link url="sendOrder" text="Order Sent" link-type="hidden-form"
                        condition="orderHeader.statusId == 'OrderApproved' &amp;&amp; firstPartInfo.isCustomerInternalOrg" confirmation="Mark order as Sent?"/>
                <link url="holdOrder" text="Hold" link-type="hidden-form" confirmation="Really hold order?"
                        condition="orderHeader.statusId in ['OrderPlaced', 'OrderProcessing', 'OrderApproved']"/>

                <link url="requestOrder" text="Quote Requested" link-type="hidden-form" confirmation="Set order as quote requested by customer?"
                        condition="orderHeader.statusId == 'OrderOpen'"/>
                <link url="proposeOrder" text="Propose Quote" link-type="hidden-form" confirmation="Propose quote to customer?"
                        condition="orderHeader.statusId in ['OrderOpen', 'OrderRequested']"/>
                <link url="rejectOrder" text="Reject Quote Request" link-type="hidden-form" confirmation="Reject quote request and reject order?"
                        condition="orderHeader.statusId == 'OrderRequested'"/>

                <container-dialog id="CloseOrderDialog" button-text="Close Order" type="warning"
                        condition="orderHeader.statusId in ['OrderOpen', 'OrderProposed', 'OrderPlaced', 'OrderProcessing', 'OrderApproved', 'OrderHold']">
                    <!-- list of OrderPart with Facility, OrderItems with Item #, Quantity, Quantity Shipped, Quantity to Cancel -->
                    <section-iterate name="CloseOrderPartList" list="orderPartInfoList" entry="orderPartInfo"><actions>
                        <set field="partProductItems" from="orderPartInfo.partNoParentOrderItemList?.findAll({ it.itemTypeEnumId in productItemTypes })"/>
                    </actions><widgets>
                        <label text="Order Part ${orderPartInfo.orderPart.orderPartSeqId} Facility ${ec.resource.expand('FacilityNameTemplate', null, orderPartInfo.facility)}" type="h4"/>
                        <form-list name="CloseOrderPartItems" list="partProductItems" skip-form="true">
                            <row-actions>
                                <set field="itemQuantityNotShipped" from="quantityNotShippedByItem.get(orderItemSeqId) ?: 0.0"/>
                                <set field="itemQuantityShipped" from="(quantity?:0.0) - itemQuantityNotShipped"/>
                            </row-actions>
                            <field name="orderItemSeqId"><default-field title="Item"><display/></default-field></field>
                            <field name="productId"><default-field title="Product">
                                <display-entity entity-name="mantle.product.Product" text="ProductNameTemplate"/></default-field></field>
                            <field name="quantity"><default-field><display/></default-field></field>
                            <field name="itemQuantityShipped"><default-field title="Shipped"><display/></default-field></field>
                            <field name="itemQuantityNotShipped"><default-field title="To Cancel">
                                <display style="${itemQuantityNotShipped ? 'text-danger' : ''}"/></default-field></field>
                        </form-list>
                    </widgets></section-iterate>
                    <label text="OrderDetailConfirmCloseOrder" type="p"/>
                    <link url="cancelOrder" text="Close Order" link-type="hidden-form" btn-type="warning"
                            confirmation="OrderDetailConfirmCloseOrder"/>
                </container-dialog>

                <container-dialog id="AddPartDialog" button-text="Add Part"
                        condition="orderHeader.statusId in ['OrderOpen', 'OrderProposed', 'OrderBeingChanged', 'OrderPlaced']">
                    <form-single name="AddPartForm" transition="createOrderPart">
                        <field name="orderId"><default-field><hidden/></default-field></field>
                        <field name="vendorPartyId" from="firstPartInfo.orderPart.vendorPartyId">
                            <default-field><hidden/></default-field></field>
                        <field name="customerPartyId" from="firstPartInfo.orderPart.customerPartyId">
                            <default-field><hidden/></default-field></field>
                        <field name="facilityId" from="firstPartInfo.orderPart.facilityId"><default-field title="Facility">
                            <drop-down><dynamic-options transition="getFacilityList" server-search="true" min-length="0"
                                    parameter-map="[facilityTypeEnumId:'FcTpWarehouse']"/></drop-down>
                        </default-field></field>
                        <field name="shipBeforeDate"><default-field><date-time/></default-field></field>
                        <field name="submitButton"><default-field title="Create"><submit/></default-field></field>
                    </form-single>
                </container-dialog>
                <link url="approveOrder" text="Uncomplete Order" link-type="hidden-form" confirmation="Change back to Approved status to allow shipping, etc?"
                        condition="ec.user.hasPermission('ORDER_APPROVE') &amp;&amp; orderHeader.statusId == 'OrderCompleted'"/>

                <link url="PrintOrder.pdf" text="Order PDF"/>

                <link url="cloneOrder" text="Clone" confirmation="Create new order based on this one?" parameter-map="[baseOrderId:orderId]"/>
                <container-dialog id="RecurDialog" button-text="Recurring" type="${orderHeader.recurCronExpression ? (orderHeader.statusId == 'OrderApproved' ? 'success' : 'warning') : 'primary'}">
                    <label text="Order is not in Approved status" type="p" style="text-warning" condition="orderHeader.statusId != 'OrderApproved'"/>
                    <label text="Recurring orders in the Approved status will be automatically cloned according to the schedule and the clone will be automatically Placed. If there are no Approve Warnings the cloned order will be automatically Approved. If Auto Invoice is set to Y then if Approved will also create an Invoice for the Order." type="p"/>
                    <form-single name="RecurOptions" map="orderHeader" transition="updateOrderRecur">
                        <field name="orderId"><default-field><hidden/></default-field></field>
                        <field name="recurCronExpression"><default-field title="Recur Schedule"><drop-down allow-empty="true">
                            <option key="${cronExpression}" text="Current: ${recurCronDescription ?: 'None'}"/><!-- NOTE: first in list so that if matches another option will be overridden -->
                            <option key="0 0 2 ? * MON" text="Weekly on Monday at 2 AM"/>
                            <option key="0 0 2 1 * ?" text="Monthly on the 1st at 2 AM"/>
                            <option key="0 0 2 15 * ?" text="Monthly on the 15th at 2 AM"/>
                        </drop-down></default-field></field>
                        <field name="recurAutoInvoice"><default-field title="Auto Invoice">
                            <radio no-current-selected-key="N"><option key="Y"/><option key="N"/></radio>
                        </default-field></field>
                        <field name="lodInfo"><default-field title="">
                            <label text="Last Ordered Date will be updated over time as recurring Order Clones are created." type="p"/>
                            <label text="If Last Ordered Date is empty the next Order Clone will be created with the next batch." type="p"/>
                            <label text="To not create the next Order Clone until the scheduled time, set this to now or any time since the last scheduled time." type="p"/>
                        </default-field></field>
                        <field name="lastOrderedDate"><default-field>
                            <date-time/></default-field></field>

                        <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                    </form-single>
                </container-dialog>

                <container-dialog id="AuditLogDialog" button-text="Audit Log" width="960">
                    <form-list name="AuditLogList" list="auditLogList" skip-form="true">
                        <entity-find entity-name="moqui.entity.EntityAuditLog" list="auditLogList">
                            <econdition field-name="changedEntityName" operator="in"
                                    from="['mantle.order.OrderHeader', 'mantle.order.OrderPart', 'mantle.order.OrderItem']"/>
                            <!-- with statusId on OrderPart include these as well for orders: <econdition field-name="changedFieldName" operator="not-equals" value="statusId"/> -->
                            <econdition field-name="pkPrimaryValue" from="orderId"/>
                            <select-field field-name="changedEntityName"/>
                            <order-by field-name="-changedDate,pkSecondaryValue"/>
                        </entity-find>

                        <field name="changedDate"><default-field title="Date"><display/></default-field></field>
                        <field name="changedByUserId"><default-field title="User">
                            <display-entity text="UsernameTemplate" entity-name="mantle.party.PersonWithUserAccount" key-field-name="userId"/></default-field></field>
                        <field name="pkSecondaryValue"><default-field title="Part/Item"><display/></default-field></field>
                        <field name="changedEntityName"><default-field title="Entity">
                            <display text="${org.moqui.util.StringUtilities.camelCaseToPretty(changedEntityName.substring(changedEntityName.lastIndexOf('.')+1))}"/></default-field></field>
                        <field name="changedFieldName"><default-field title="Field">
                            <display text="${org.moqui.util.StringUtilities.camelCaseToPretty(changedFieldName)}"/></default-field></field>
                        <field name="oldValueText"><default-field title="From">
                            <display text="${ec.entity.formatFieldString(changedEntityName, changedFieldName, oldValueText)}"/></default-field></field>
                        <field name="newValueText"><default-field title="To">
                            <display text="${ec.entity.formatFieldString(changedEntityName, changedFieldName, newValueText)}"/></default-field></field>
                    </form-list>
                </container-dialog>

                <section-iterate name="InvoiceLinks" list="invoiceIdSet" entry="invoiceId"><widgets>
                    <link url="editInvoice" text="Invoice ${invoiceId}" link-type="anchor-button"/>
                </widgets></section-iterate>

                <form-single name="HeaderForm" transition="updateOrderHeader" map="orderHeader">
                    <field name="orderId"><default-field><hidden/></default-field></field>

                    <field name="parentOrderId"><conditional-field title="Parent Order" condition="parentOrderId">
                        <link url="." text="${parentOrderId}" parameter-map="[orderId:parentOrderId]" link-type="anchor"/>
                    </conditional-field></field>

                    <field name="statusId"><default-field title="Status">
                        <display text="${statusItem.description}"/></default-field></field>
                    <field name="entryDate"><default-field title="Entry"><display/></default-field></field>
                    <field name="placedDate"><conditional-field condition="orderEditable" title="Placed"><date-time/></conditional-field>
                        <default-field title="Placed"><display/></default-field></field>
                    <field name="orderName">
                        <conditional-field condition="orderEditable"><text-line size="40"/></conditional-field>
                        <default-field title="Name"><display/></default-field>
                    </field>
                    <field name="orderRevision"><default-field title="Revision"><display also-hidden="false"/></default-field></field>
                    <field name="salesChannelEnumId">
                        <conditional-field condition="orderEditable" title="Source">
                            <widget-template-include location="component://webroot/template/screen/BasicWidgetTemplates.xml#enumDropDown">
                                <set field="enumTypeId" value="SalesChannel"/><set field="allowEmpty" value="true"/></widget-template-include>
                        </conditional-field>
                        <default-field title="Source"><display-entity entity-name="moqui.basic.Enumeration"/></default-field>
                    </field>
                    <field name="systemMessageRemoteId">
                        <conditional-field condition="orderEditable" title="Message Remote">
                            <drop-down allow-empty="true">
                                <entity-options key="${systemMessageRemoteId}" text="${description}">
                                    <entity-find entity-name="moqui.service.message.SystemMessageRemote">
                                        <order-by field-name="description"/></entity-find></entity-options>
                            </drop-down>
                        </conditional-field>
                        <default-field title="Message Remote"><display-entity entity-name="moqui.service.message.SystemMessageRemote" key-field-name="systemMessageRemoteId"/></default-field>
                    </field>
                    <field name="displayId">
                        <conditional-field condition="orderEditable"><text-line size="20"/></conditional-field>
                        <default-field><display/></default-field>
                    </field>
                    <field name="externalId">
                        <conditional-field condition="orderEditable"><text-line size="20"/></conditional-field>
                        <default-field><display/></default-field>
                    </field>
                    <field name="externalRevision"><conditional-field title="Ext Rev" condition="externalRevision">
                        <display also-hidden="false"/></conditional-field></field>
                    <field name="grandTotal"><default-field><display currency-unit-field="currencyUomId"/></default-field></field>
                    <field name="submitButton">
                        <conditional-field condition="orderEditable" title="Update Header"><submit/></conditional-field>
                        <default-field><ignored/></default-field>
                    </field>
                    <field-layout>
                        <field-ref name="parentOrderId"/>
                        <field-row><field-ref name="statusId"/><field-ref name="orderRevision"/></field-row>
                        <field-row><field-ref name="entryDate"/><field-ref name="placedDate"/></field-row>
                        <field-ref name="orderName"/>
                        <field-row><field-ref name="salesChannelEnumId"/><field-ref name="systemMessageRemoteId"/></field-row>
                        <field-row><field-ref name="displayId"/><field-ref name="externalId"/></field-row>
                        <field-row><field-ref name="grandTotal"/><field-ref name="externalRevision"/></field-row>

                        <field-ref name="submitButton"/>
                    </field-layout>
                </form-single>

                <section name="OrderPromoCodeSection"><actions>
                    <entity-find entity-name="mantle.product.store.PartyPromoCodeDetail" list="partyPromoCodeDetailList">
                        <date-filter valid-date="orderHeader.placedDate"/>
                        <date-filter from-field-name="promoFromDate" thru-field-name="promoThruDate" valid-date="orderHeader.placedDate"/>
                        <econdition field-name="partyId" from="firstPart.customerPartyId"/>
                        <econdition field-name="productStoreId" from="orderHeader.productStoreId" ignore-if-empty="true"/>
                    </entity-find>
                </actions><widgets>
                    <container-box><box-header title="Promo Codes"/><box-toolbar>
                        <container-dialog id="AddPromoCodeDialog" button-text="Add Promo Code">
                            <form-single name="AddPromoCode" transition="addOrderPromoCode">
                                <field name="orderId"><default-field><hidden/></default-field></field>
                                <field name="promoCode"><default-field title="Any Promo Code"><text-line size="8"/></default-field></field>
                                <field name="addButton"><default-field title=""><submit text="Add Code"/></default-field></field>
                                <field-layout><field-row-big><field-ref name="promoCode"/><field-ref name="addButton"/></field-row-big></field-layout>
                            </form-single>
                            <section name="AddPartyPromoCodeSection" condition="partyPromoCodeDetailList"><widgets>
                                <form-single name="AddPartyPromoCode" transition="addOrderPromoCode">
                                    <field name="orderId"><default-field><hidden/></default-field></field>
                                    <field name="promoCode"><default-field title="Customer Promo Code"><drop-down>
                                        <list-options list="partyPromoCodeDetailList" key="${promoCode}" text="${promoCode} - ${itemDescription ?: '[' + storePromotionId + ']'}"/>
                                    </drop-down></default-field></field>
                                    <field name="addButton"><default-field title=""><submit text="Add Code"/></default-field></field>
                                    <field-layout><field-row-big><field-ref name="promoCode"/><field-ref name="addButton"/></field-row-big></field-layout>
                                </form-single>
                            </widgets></section>
                        </container-dialog>
                    </box-toolbar><box-body-nopad>
                        <form-list name="OrderPromoCodeList" list="orderPromoCodeDetailList" transition="removeOrderPromoCode">
                            <field name="orderId"><default-field><hidden/></default-field></field>
                            <field name="promoCodeId"><default-field><hidden/></default-field></field>
                            <field name="promoCode"><default-field><display/></default-field></field>
                            <field name="itemDescription"><default-field title="Promotion">
                                <!-- TODO: change to link to edit promotion screen once exists -->
                                <display text="${itemDescription ?: '[' + storePromotionId + ']'}"/></default-field></field>
                            <field name="thruDate"><default-field title="Code Expires"><display/></default-field></field>
                            <field name="promoThruDate"><default-field title="Promo Expires"><display/></default-field></field>
                            <field name="promoThruDate"><default-field title="Promo Expires"><display/></default-field></field>
                            <field name="removeButton"><default-field title=""><submit icon="fa fa-trash"/></default-field></field>
                        </form-list>
                    </box-body-nopad></container-box>
                </widgets></section>
            </row-col><row-col lg="6">
                <section name="ItemLimitSection" condition="orderItemNoParentCount &gt; 10"><widgets>
                    <form-single name="ItemLimitForm" transition="setItemLimit">
                        <field name="orderId"><default-field><hidden/></default-field></field>
                        <field name="itemLimit"><default-field><drop-down>
                            <option key="10"/><option key="20"/><option key="50"/><option key="100"/>
                        </drop-down></default-field></field>
                        <field name="submitBtn"><default-field title="Update"><submit/></default-field></field>
                        <field-layout><field-row-big><field-ref name="itemLimit"/><field-ref name="submitBtn"/></field-row-big></field-layout>
                    </form-single>
                </widgets></section>

                <section-include name="StatusHistorySection" location="component://SimpleScreens/template/basic/StatusWidgets.xml"/>

                <section name="CustomerNotesSection"><actions>
                    <entity-find entity-name="mantle.party.PartyNote" list="customerNoteList">
                        <econdition field-name="partyId" from="firstPartInfo.orderPart.customerPartyId"/>
                        <order-by field-name="-noteDate"/>
                    </entity-find>
                </actions><widgets>
                    <section name="CustomerNotesInner" condition="customerNoteList"><widgets>
                        <container-box type="danger"><box-header title="Customer Notes"/><box-body>
                            <section-iterate name="CustomerNoteIterate" list="customerNoteList" entry="partyNote"><actions>
                                <entity-find-one entity-name="mantle.party.PersonWithUserAccount" value-field="paua">
                                    <field-map field-name="userId" from="partyNote.userId"/></entity-find-one>
                            </actions><widgets>
                                <label text="By ${paua?.firstName?:''} ${paua?.lastName?:''} (${paua?.username ?: partyNote.userId}) at ${ec.l10n.format(partyNote.noteDate, 'yyyy-MM-dd HH:mm')}" type="strong"/>
                                <label text="${partyNote.noteText}" type="p"/>
                            </widgets></section-iterate>
                        </box-body></container-box>
                    </widgets></section>
                </widgets></section>

                <section name="NotesSection"><widgets>
                    <container-box><box-header title="Order Notes"/><box-toolbar>
                        <container-dialog id="NewNoteDialog" button-text="Add Note">
                            <form-single name="NewNoteForm" transition="createNote">
                                <field name="orderId"><default-field><hidden/></default-field></field>
                                <field name="noteText"><default-field title="Note"><text-area cols="60" rows="6"/></default-field></field>
                                <field name="submitButton"><default-field title="Add Note"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                    </box-toolbar><box-body>
                        <section-iterate name="NoteIterateSection" list="orderNoteList" entry="note"><actions>
                            <entity-find-one entity-name="mantle.party.PersonWithUserAccount" value-field="paua">
                                <field-map field-name="userId" from="note.userId"/></entity-find-one>
                        </actions><widgets>
                            <label text="By ${paua?.firstName?:''} ${paua?.lastName?:''} (${paua?.username ?: note.userId}) at ${ec.l10n.format(note.noteDate, 'yyyy-MM-dd HH:mm')}" type="strong"/>
                            <section name="UpdateNoteSection" condition="note.userId == ec.user.userId"><widgets>
                                <container-dialog id="UpdateNoteContainer" button-text="Edit Note">
                                    <form-single name="UpdateNoteForm" transition="updateNote" map="note">
                                        <field name="orderId"><default-field><hidden/></default-field></field>
                                        <field name="noteDate"><default-field><hidden/></default-field></field>
                                        <field name="noteText"><default-field title="Note"><text-area cols="60" rows="6"/></default-field></field>
                                        <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                                    </form-single>
                                </container-dialog>
                            </widgets></section>
                            <label text="${note.noteText}" type="p"/>
                        </widgets></section-iterate>
                    </box-body></container-box>
                </widgets></section>

                <section name="ContentSection"><actions>
                    <entity-find entity-name="mantle.order.OrderContent" list="contentList">
                        <econdition field-name="orderId"/><order-by field-name="-contentDate"/></entity-find>
                </actions><widgets>
                    <container-box><box-header title="Attachments"/><box-toolbar>
                        <container-dialog id="NewContentDialog" button-text="Add Attachment">
                            <form-single name="NewContentForm" transition="createContent">
                                <field name="orderId"><default-field><hidden/></default-field></field>
                                <field name="contentFile"><default-field><file/></default-field></field>
                                <field name="description"><default-field><text-line size="60"/></default-field></field>
                                <field name="submitButton"><default-field title="Add Attachment"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                    </box-toolbar><box-body>
                        <section-iterate name="ContentIterateSection" list="contentList" entry="content"><actions>
                            <entity-find-one entity-name="mantle.party.PersonWithUserAccount" value-field="paua">
                                <field-map field-name="userId" from="content.userId"/></entity-find-one>
                        </actions><widgets><container>
                            <link url="downloadContent" condition="content.contentLocation"
                                    parameter-map="[orderContentId:content.orderContentId]"
                                    text="Download ${content.contentLocation.substring(content.contentLocation.lastIndexOf('/')+1)}"/>
                            <section name="UpdateContentContainerSection" condition="orderEditable"><widgets>
                                <container-dialog id="UpdateContentContainer" button-text="Edit Attachment">
                                    <form-single name="UpdateContentForm" transition="updateContent" map="content">
                                        <field name="orderContentId"><default-field><hidden/></default-field></field>
                                        <field name="orderId"><default-field><hidden/></default-field></field>
                                        <field name="contentFile"><default-field><file/></default-field></field>
                                        <field name="description"><default-field><text-line size="60"/></default-field></field>
                                        <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                                    </form-single>
                                </container-dialog>
                            </widgets></section>
                            <container><label text="By ${paua?.firstName?:''} ${paua?.lastName?:''} (${paua?.username ?: content.userId}) at ${ec.l10n.format(content.contentDate, 'yyyy-MM-dd HH:mm')}"/></container>
                            <label text="${content.description ?: 'No Description'}" type="p"/>
                        </container></widgets></section-iterate>
                    </box-body></container-box>
                </widgets></section>

                <section name="EmailMessageSection"><widgets>
                    <container-box><box-header title="Email Messages"/><box-toolbar>
                        <section name="SendPlacedEmailSection" condition="!(orderHeader.statusId in ['OrderBeingChanged'])"><actions>
                            <set field="customerPartyId" from="orderPartList[0].customerPartyId"/>
                            <if condition="customerPartyId">
                                <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="emailInfo"
                                        in-map="[partyId:customerPartyId, emailContactMechPurposeId:'EmailOrder', defaultToPrimaryPurpose:true]"/>
                                <set field="toAddresses" from="emailInfo.emailAddress"/>
                            </if>
                        </actions><widgets>
                            <container-dialog id="SendPlacedEmailDialog" button-text="Send Email">
                                <form-single name="SendPlacedEmailForm" transition="sendOrderStoreEmail">
                                    <field name="orderId"><default-field><hidden/></default-field></field>
                                    <field name="forceByType"><default-field><hidden default-value="true"/></default-field></field>
                                    <field name="emailTypeEnumId" from="'PsetOrderPlaced'"><default-field><hidden/></default-field></field>
                                    <field name="toAddresses"><default-field title="To Address"><text-line size="40"/></default-field></field>
                                    <field name="submitButton"><default-field title="Send Email"><submit/></default-field></field>
                                </form-single>
                            </container-dialog>
                        </widgets></section>
                    </box-toolbar><box-body-nopad>
                        <form-list name="EmailMessageList" list="emailMessageList" skip-form="true">
                            <entity-find entity-name="mantle.order.OrderEmailMessageDetail" list="emailMessageList">
                                <econdition field-name="orderId"/><order-by field-name="sentDate,emailMessageId"/></entity-find>
                            <field name="emailMessageId"><default-field title="ID">
                                <link url="EmailMessage" text="${emailMessageId}" link-type="anchor" target-window="_blank"/>
                            </default-field></field>
                            <field name="orderRevision"><default-field title="Rev"><display/></default-field></field>
                            <field name="sentDate"><default-field><display/></default-field></field>
                            <field name="toAddresses"><default-field><display/></default-field></field>
                            <field name="statusId"><default-field title="Status">
                                <display-entity entity-name="moqui.basic.StatusItem"/></default-field></field>
                            <field name="receivedDate"><default-field><display/></default-field></field>
                            <field name="emailTypeEnumId"><default-field title="Email Type">
                                <display-entity entity-name="moqui.basic.Enumeration"/></default-field></field>
                            <field name="sendLink"><default-field title=""><link url="sendEmailMessage" text="Send"
                                    parameter-map="[emailMessageId:emailMessageId]" condition="!(statusId in ['ES_DRAFT', 'ES_CANCELLED'])"
                                    confirmation="Send this email message?"/>
                            </default-field></field>
                        </form-list>
                    </box-body-nopad></container-box>
                </widgets></section>

                <section name="SystemMessageSection" condition="systemMessageList"><widgets>
                    <container-box><box-header title="System Messages"/><box-body-nopad>
                        <form-list name="SystemMessageList" list="systemMessageList" skip-form="true">
                            <field name="systemMessageId"><default-field title="Message">
                                <link url="systemMessageDetail" text="${systemMessageId}" link-type="anchor"/>
                            </default-field></field>
                            <field name="isOutgoing"><default-field title="In/Out"><display text="${isOutgoing == 'Y' ? 'Out' : 'In'}"/></default-field></field>
                            <field name="initDate"><default-field title="Init"><display/></default-field></field>
                            <field name="processedDate"><default-field title="Processed"><display/></default-field></field>
                            <field name="statusId"><default-field title="Status">
                                <display-entity entity-name="moqui.basic.StatusItem"/></default-field></field>
                            <field name="systemMessageTypeId"><default-field title="Type">
                                <display-entity entity-name="moqui.service.message.SystemMessageType" text="${description}"/></default-field></field>
                            <field name="systemMessageRemoteId"><default-field title="Remote">
                                <display-entity entity-name="moqui.service.message.SystemMessageRemote" text="${description}"/></default-field></field>
                        </form-list>
                    </box-body-nopad></container-box>
                </widgets></section>

                <section name="ChildOrders" condition="childOrderList"><widgets>
                    <container-box><box-header title="Child/Cloned Orders"/><box-body>
                        <form-list name="ChildOrderList" list="childOrderList" skip-form="true">
                            <field name="orderId"><default-field title="Order">
                                <link url="." text="${orderId}" link-type="anchor"/></default-field></field>
                            <field name="statusId"><default-field title="Status">
                                <display-entity entity-name="moqui.basic.StatusItem"/></default-field></field>
                            <field name="entryDate"><default-field><display/></default-field></field>
                            <field name="approvedDate"><default-field title="Approved"><display/></default-field></field>
                            <field name="grandTotal"><default-field title="Total"><display format="#,##0.00"/></default-field></field>
                        </form-list>
                    </box-body></container-box>
                </widgets></section>
            </row-col></container-row>
        </widgets></section>

        <section-iterate name="OrderPartSection" list="orderPartInfoList" entry="orderPartInfo"><actions>
            <set field="contactInfo" from="orderPartInfo.facilityContactInfo"/>
            <set field="orderPart" from="orderPartInfo.orderPart"/>
            <set field="orderPartSeqId" from="orderPart.orderPartSeqId"/>
            <set field="customerPartyId" from="orderPart.customerPartyId"/>
            <set field="customerShipToPartyId" from="orderPartInfo.customerShipToDetail?.partyId"/>
            <set field="customerBillToPartyId" from="orderPartInfo.customerBillToDetail?.partyId"/>

            <!-- limit parent items (from items for part with no parent item) -->
            <!-- NOTE: no longer product type items only to allow discounts on shipping, etc: ?.findAll({ it.itemTypeEnumId in productItemTypes }) -->
            <set field="applicableParentItems" from="orderPartInfo.partNoParentOrderItemList"/>

            <!-- get shippingOptions for initial load (before drop-down dynamic call with rates which may be slow) -->
            <service-call name="mantle.product.StoreServices.get#StoreShippingOptions" out-map="context"
                    in-map="[productStoreId:orderHeader.productStoreId, orderId:orderId, orderPartSeqId:orderPartSeqId,
                            postalContactMechId:orderPart.postalContactMechId, getRates:false]"/>

            <!-- get addresses for customer, ship-to customer -->
            <set field="shippingPostalAddressList" from="new ArrayList()"/>
            <set field="customerShipPartyIdSet" from="new TreeSet()"/>
            <script>if (customerPartyId) customerShipPartyIdSet.add(customerPartyId)</script>
            <script>if (customerShipToPartyId) customerShipPartyIdSet.add(customerShipToPartyId)</script>
            <iterate list="customerShipPartyIdSet" entry="curPartyId">
                <!-- addresses on profile -->
                <service-call name="mantle.party.ContactServices.get#PartyContactInfoList" out-map="customerShippingInfo"
                        in-map="[partyId:curPartyId, postalContactMechPurposeId:'PostalShippingDest']"/>
                <script>shippingPostalAddressList.addAll(customerShippingInfo.postalAddressList ?: [])</script>
                <!-- addresses on owned facilities -->
                <entity-find entity-name="mantle.facility.Facility" list="curFacList">
                    <econdition field-name="ownerPartyId" from="curPartyId"/></entity-find>
                <iterate list="curFacList" entry="curFac">
                    <service-call name="mantle.facility.ContactServices.get#FacilityContactInfo" out-map="facContactInfo" out-map-add-to-existing="false"
                            in-map="[facilityId:curFac.facilityId, postalContactMechPurposeId:'PostalPrimary',
                                telecomContactMechPurposeId:'PhonePrimary', emailContactMechPurposeId:'EmailPrimary']"/>
                    <if condition="facContactInfo.postalContactMech"><script>shippingPostalAddressList.add(facContactInfo)</script></if>
                </iterate>
            </iterate>
            <!-- if address set on OrderPart that isn't in list yet, add it (could be expired, etc) -->
            <if condition="customerPartyId &amp;&amp; orderPart.postalContactMechId &amp;&amp; !(orderPart.postalContactMechId in shippingPostalAddressList*.postalContactMechId)">
                <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="curPaInfo"
                        in-map="[partyId:customerPartyId, postalContactMechId:orderPart.postalContactMechId]"/>
                <script>shippingPostalAddressList.add(0, curPaInfo)</script>
            </if>
            <!-- trim duplicates and replaced/valid from shippingPostalAddressList -->
            <script><![CDATA[
                Set replacedPostalIdSet = new HashSet()
                for (int i=0; i < shippingPostalAddressList.size(); i++) {
                    String replAddressId = shippingPostalAddressList.get(i).postalContactMech?.replacesContactMechId
                    if (replAddressId && !replAddressId.equals(orderPart.postalContactMechId)) replacedPostalIdSet.add(replAddressId)
                }
                Set shippingPostalIdSet = new HashSet()
                for (int i=0; i < shippingPostalAddressList.size(); ) {
                    String curAddressId = shippingPostalAddressList.get(i).postalContactMechId
                    if (shippingPostalIdSet.contains(curAddressId) || replacedPostalIdSet.contains(curAddressId)) { shippingPostalAddressList.remove(i) }
                    else { shippingPostalIdSet.add(curAddressId); i++ }
                }
            ]]></script>
            <set field="shippingAddressInfo" from="orderPart.postalContactMechId ? shippingPostalAddressList.find({ orderPart.postalContactMechId.equals(it.postalContactMechId) }) : null"/>
        </actions><widgets>
            <container type="hr"/>
            <container-row style="shaded-area">
                <row-col lg="5">
                    <container><label text="${orderPartInfo.isVendorInternalOrg ? 'Sales' : 'Purchase'} Order Part ${orderPart.orderPartSeqId}" type="h4"/></container>

                    <section name="ShipOrderPartSection"><condition>
                        <expression>quantityNotShippedByPart.get(orderPart.orderPartSeqId) &gt; 0 &amp;&amp; !orderHeader.recurCronExpression &amp;&amp;
                            (orderHeader.statusId == "OrderApproved" || orderHeader.statusId == "OrderSent")</expression>
                    </condition><actions>
                        <!-- find Shipments from same vendor going to same address and ship method, in Input or Scheduled status -->
                        <entity-find entity-name="mantle.shipment.ShipmentSegmentFacilityStatus" list="ssfsList">
                            <econdition field-name="destPostalContactMechId" from="orderPartInfo.orderPart.postalContactMechId"/>
                            <econdition field-name="shipmentMethodEnumId" from="orderPartInfo.orderPart.shipmentMethodEnumId"/>
                            <econdition field-name="fromPartyId" from="orderPartInfo.orderPart.vendorPartyId"/>
                            <econdition field-name="statusId" operator="in" value="ShipInput,ShipScheduled"/>
                            <order-by field-name="shipmentId"/>
                        </entity-find>
                    </actions><widgets>
                        <link url="shipOrderPart" text="Create Shipment" link-type="hidden-form" btn-type="success">
                            <parameter name="orderId"/><parameter name="orderPartSeqId" from="orderPart.orderPartSeqId"/></link>

                        <section name="AddPartToShipmentSection" condition="ssfsList"><widgets>
                            <container-dialog id="AddOrderPartToShipmentDialog" button-text="Add Part to Shipment">
                                <form-single name="AddOrderPartToShipmentForm" transition="addOrderPartToShipment">
                                    <field name="orderId"><default-field><hidden/></default-field></field>
                                    <field name="orderPartSeqId" from="orderPart.orderPartSeqId">
                                        <default-field><hidden/></default-field></field>
                                    <field name="shipmentId"><default-field title="Shipment"><drop-down>
                                        <list-options list="ssfsList" key="${shipmentId}" text="${shipmentId}"/>
                                    </drop-down></default-field></field>
                                    <field name="submitButton"><default-field title="Add"><submit/></default-field></field>
                                </form-single>
                            </container-dialog>
                        </widgets></section>
                    </widgets></section>
                    <section-iterate name="ShipmentLinks" list="new ArrayList(orderPartInfo.partShipmentIdSet).reverse()" entry="shipmentId"><widgets>
                        <link url="shipmentDetail" text="Shipment ${shipmentId}" link-type="anchor-button"/>
                    </widgets></section-iterate>

                    <section name="EditPartSection" condition="orderPartInfo.partEditable"><widgets>
                        <container-dialog id="EditPartDialog" button-text="Edit Part ${orderPart.orderPartSeqId}" width="960">
                            <form-single name="EditPartForm" transition="updateOrderPart" map="orderPart">
                                <field name="orderId"><default-field><hidden/></default-field></field>
                                <field name="orderPartSeqId"><default-field><hidden/></default-field></field>
                                <field name="customerPartyId"><conditional-field title="Customer" condition="orderPartInfo.isVendorInternalOrg">
                                    <drop-down allow-empty="true"><dynamic-options transition="searchPartyList" server-search="true"
                                            min-length="2" parameter-map="[roleTypeId:'Customer']"/></drop-down>
                                </conditional-field></field>
                                <field name="facilityId"><default-field title="Facility">
                                    <drop-down><dynamic-options transition="getFacilityList" server-search="true" min-length="0"
                                            parameter-map="[facilityTypeEnumId:'FcTpWarehouse']"/></drop-down>
                                </default-field></field>

                                <field name="priority"><default-field><radio no-current-selected-key="5">
                                    <option key="1"/><option key="2"/><option key="3"/><option key="4"/><option key="5"/>
                                    <option key="6"/><option key="7"/><option key="8"/><option key="9"/>
                                </radio></default-field></field>
                                <field name="shipAfterDate"><default-field title="Ship After"><date-time/></default-field></field>
                                <field name="shipBeforeDate"><default-field title="Ship Before"><date-time/></default-field></field>
                                <field name="estimatedShipDate"><default-field title="Estimated Ship"><date-time/></default-field></field>
                                <field name="estimatedDeliveryDate"><default-field title="Estimated Delivery"><date-time/></default-field></field>
                                <field name="otherPartyOrderId"><default-field title="Their Order ID"><text-line size="40"/></default-field></field>
                                <field name="otherPartyOrderDate"><default-field title="Their Order Date"><date-time/></default-field></field>

                                <field name="shippingInstructions"><default-field><text-area rows="6" cols="120"/></default-field></field>
                                <field name="signatureRequiredEnumId"><default-field title="Sign Req.">
                                    <widget-template-include location="component://webroot/template/screen/BasicWidgetTemplates.xml#enumDropDown">
                                        <set field="enumTypeId" value="SignatureRequired"/><set field="allowEmpty" value="true"/></widget-template-include>
                                </default-field></field>
                                <field name="isGift"><default-field>
                                    <radio no-current-selected-key="N"><option key="N"/><option key="Y"/></radio></default-field></field>
                                <field name="giftMessage"><default-field><text-area rows="3" cols="60"/></default-field></field>
                                <field name="disablePromotions"><default-field>
                                    <radio no-current-selected-key="N"><option key="N"/><option key="Y"/></radio></default-field></field>
                                <field name="disableShippingCalc"><default-field>
                                    <radio no-current-selected-key="N"><option key="N"/><option key="Y"/></radio></default-field></field>
                                <field name="disableTaxCalc"><default-field>
                                    <radio no-current-selected-key="N"><option key="N"/><option key="Y"/></radio></default-field></field>
                                <field name="reservationAutoEnumId"><default-field title="Auto Res.">
                                    <widget-template-include location="component://webroot/template/screen/BasicWidgetTemplates.xml#enumDropDown">
                                        <set field="enumTypeId" value="AssetReservationAuto"/><set field="allowEmpty" value="true"/></widget-template-include>
                                </default-field></field>
                                <field name="settlementTermId"><default-field title="Payment Terms">
                                    <drop-down allow-empty="true"><entity-options key="${settlementTermId}" text="${description}">
                                        <entity-find entity-name="mantle.account.invoice.SettlementTermAndEnumMember">
                                            <econdition field-name="enumGroupEnumId" value="EngPaymentTermType"/>
                                            <order-by field-name="description"/>
                                        </entity-find>
                                    </entity-options></drop-down>
                                </default-field></field>
                                <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                    </widgets><fail-widgets>
                        <container-dialog id="EditPartNonEdDialog" button-text="Edit Part ${orderPart.orderPartSeqId}" width="960">
                            <form-single name="EditPartNonEdForm" transition="updateOrderPart" map="orderPart">
                                <field name="orderId"><default-field><hidden/></default-field></field>
                                <field name="orderPartSeqId"><default-field><hidden/></default-field></field>

                                <field name="priority"><default-field><radio no-current-selected-key="5">
                                    <option key="1"/><option key="2"/><option key="3"/><option key="4"/><option key="5"/>
                                    <option key="6"/><option key="7"/><option key="8"/><option key="9"/>
                                </radio></default-field></field>
                                <field name="shipAfterDate"><default-field title="Ship After"><date-time/></default-field></field>
                                <field name="shipBeforeDate"><default-field title="Ship Before"><date-time/></default-field></field>
                                <field name="estimatedShipDate"><default-field title="Estimated Ship"><date-time/></default-field></field>
                                <field name="estimatedDeliveryDate"><default-field title="Delivery Date"><date-time/></default-field></field>
                                <field name="otherPartyOrderId"><default-field title="Their Order ID"><text-line size="40"/></default-field></field>
                                <field name="otherPartyOrderDate"><default-field title="Their Order Date"><date-time/></default-field></field>

                                <field name="shippingInstructions"><default-field><text-area rows="6" cols="120"/></default-field></field>
                                <field name="signatureRequiredEnumId"><default-field title="Sign Req.">
                                    <display-entity entity-name="moqui.basic.Enumeration"/></default-field></field>
                                <field name="isGift"><default-field>
                                    <radio no-current-selected-key="N"><option key="N"/><option key="Y"/></radio></default-field></field>
                                <field name="giftMessage"><default-field><text-area rows="3" cols="80"/></default-field></field>
                                <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                    </fail-widgets></section>
                    <container-dialog id="AddPartPartyDialog" button-text="Add Party">
                        <form-single name="CreateOrderPartParty" transition="createOrderPartParty" map="orderPart">
                            <field name="orderId"><default-field><hidden/></default-field></field>
                            <field name="orderPartSeqId"><default-field><hidden/></default-field></field>
                            <field name="partyId"><default-field title="Party"><drop-down>
                                <dynamic-options transition="searchPartyList" server-search="true" min-length="2"/></drop-down>
                            </default-field></field>
                            <field name="roleTypeId"><default-field title="Role">
                                <drop-down><entity-options key="${roleTypeId}" text="${description}">
                                    <entity-find entity-name="mantle.party.RoleGroupMemberAndType" cache="true">
                                        <econdition field-name="roleGroupEnumId" value="RgpOrder"/>
                                        <order-by field-name="description"/></entity-find>
                                </entity-options></drop-down>
                            </default-field></field>
                            <field name="submitButton"><default-field title="Add"><submit/></default-field></field>
                        </form-single>
                    </container-dialog>

                    <link url="invoiceOrderPart" text="Create Invoice" link-type="hidden-form"
                            parameter-map="[orderPartSeqId:orderPart.orderPartSeqId]"
                            condition="quantityNotBilledByPart.get(orderPartInfo.orderPart.orderPartSeqId) &amp;&amp; !orderHeader.recurCronExpression"/>
                    <link url="createReturnFromOrder" text="Create Return" condition="!orderPartInfo.openReturnList &amp;&amp; !orderHeader.recurCronExpression"
                            confirmation="Really create return for this order part?"
                            parameter-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId]"/>

                    <container-dialog id="ClosePartDialog" button-text="Close Part" type="warning"
                            condition="orderPartInfo.orderPart.statusId in ['OrderOpen', 'OrderPlaced', 'OrderProcessing', 'OrderApproved', 'OrderHold']">
                        <!-- show Facility, OrderItems with Item #, Quantity, Quantity Shipped, Quantity to Cancel -->
                        <section name="ClosePartInfo"><actions>
                            <set field="partProductItems" from="orderPartInfo.partNoParentOrderItemList?.findAll({ it.itemTypeEnumId in productItemTypes })"/>
                        </actions><widgets>
                            <label text="Order Part ${orderPartInfo.orderPart.orderPartSeqId} Facility ${ec.resource.expand('FacilityNameTemplate', null, orderPartInfo.facility)}" type="h4"/>
                            <form-list name="CloseOrderPartItems" list="partProductItems" skip-form="true">
                                <row-actions>
                                    <set field="itemQuantityNotShipped" from="quantityNotShippedByItem.get(orderItemSeqId) ?: 0.0"/>
                                    <set field="itemQuantityShipped" from="(quantity?:0.0) - itemQuantityNotShipped"/>
                                </row-actions>
                                <field name="orderItemSeqId"><default-field title="Item"><display/></default-field></field>
                                <field name="productId"><default-field title="Product">
                                    <display-entity entity-name="mantle.product.Product" text="ProductNameTemplate"/></default-field></field>
                                <field name="quantity"><default-field><display/></default-field></field>
                                <field name="itemQuantityShipped"><default-field title="Shipped"><display/></default-field></field>
                                <field name="itemQuantityNotShipped"><default-field title="To Cancel">
                                    <display style="${itemQuantityNotShipped ? 'text-danger' : ''}"/></default-field></field>
                            </form-list>
                        </widgets></section>

                        <label text="OrderDetailConfirmClosePart" type="p"/>
                        <link url="cancelOrderPart" text="Close Part" link-type="hidden-form" btn-type="warning"
                                confirmation="OrderDetailConfirmClosePart"/>
                    </container-dialog>

                    <label text="Warning: both vendor and customer are internal organizations" style="text-danger" type="p"
                           condition="orderPartInfo.isVendorInternalOrg &amp;&amp; orderPartInfo.isCustomerInternalOrg"/>
                    <container type="dl" style="dl-horizontal">
                        <label text="Part Total" type="dt"/>
                        <label text="${ec.l10n.formatCurrency(orderPartInfo.orderPart.partTotal ?: 0, orderHeader?.currencyUomId)}" type="dd"/>
                        <label text="Part Status" type="dt"/>
                        <container type="dd">
                            <label text="${orderPartInfo.partStatusItem?.description ?: ''}"/>
                            <link url="placeOrder" text="- Place Part" link-type="hidden-form-link"
                                    condition="orderHeader.statusId == 'OrderPlaced' &amp;&amp; orderPartInfo.orderPart.statusId in ['OrderOpen', 'OrderHold']"
                                    parameter-map="[orderId:orderId, orderPartSeqId:orderPartInfo.orderPart.orderPartSeqId]"/>
                            <link url="holdOrder" text="- Hold Part" link-type="hidden-form-link"
                                    condition="orderHeader.statusId in ['OrderPlaced', 'OrderHold', 'OrderProcessing', 'OrderApproved'] &amp;&amp; orderPartInfo.orderPart.statusId in ['OrderPlaced', 'OrderProcessing', 'OrderApproved']"
                                    parameter-map="[orderId:orderId, orderPartSeqId:orderPartInfo.orderPart.orderPartSeqId]"
                                    confirmation="Really hold order part?"/>
                            <link url="approveOrder" text="- Approve Part" link-type="hidden-form-link"
                                    condition="orderHeader.statusId == 'OrderApproved' &amp;&amp; orderPartInfo.orderPart.statusId in ['OrderPlaced', 'OrderProcessing', 'OrderHold'] &amp;&amp; ec.user.hasPermission('ORDER_APPROVE')"
                                    parameter-map="[orderId:orderId, orderPartSeqId:orderPartInfo.orderPart.orderPartSeqId]"/>
                            <link url="completeOrderPart" text="- Complete Part" link-type="hidden-form-link"
                                    parameter-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId]"
                                    condition="orderPartInfo.orderPart.statusId in ['OrderApproved', 'OrderSent']"
                                    confirmation="Force complete order part? This normally happens automatically and only when all items are shipped."/>
                        </container>
                        <label text="Customer" type="dt"/>
                        <container type="dd">
                            <link url="editParty" text="PartyNameTemplate" text-map="orderPartInfo.customerDetail"
                                    link-type="anchor" parameter-map="[partyId:orderPartInfo.customerDetail.partyId]" condition="orderPartInfo.customerDetail != null &amp;&amp; orderPartInfo.isCustomerInternalOrg"/>
                            <link url="editCustomer" text="PartyNameTemplate" text-map="orderPartInfo.customerDetail"
                                    link-type="anchor" parameter-map="[partyId:orderPartInfo.customerDetail.partyId]" condition="orderPartInfo.customerDetail != null &amp;&amp; !orderPartInfo.isCustomerInternalOrg"/>
                            <label text="No Customer Selected" style="text-danger" condition="orderPartInfo.customerDetail == null"/>
                        </container>
                        <label text="Customer Email" type="dt" condition="!isCustomerInternalOrg"/>
                        <label text="${orderPartInfo.customerEmail ?: 'No Order or Primary email found'}" type="dd"
                                style="${orderPartInfo.customerEmail ? '' : 'text-warning'}" condition="!isCustomerInternalOrg"/>
                        <label text="New Customer" type="dt" style="text-warning" condition="orderPartInfo.orderPart.isNewCustomer == 'Y'"/>
                        <label text="First Order" type="dd" style="text-warning" condition="orderPartInfo.orderPart.isNewCustomer == 'Y'"/>
                        <label text="Store" type="dt" condition="productStore != null"/>
                        <label text="${productStore.productStoreId}: ${productStore.storeName}" type="dd" condition="productStore != null"/>
                        <label text="Vendor" type="dt"/>
                        <container type="dd">
                            <link url="editParty" text="PartyNameTemplate" text-map="orderPartInfo.vendorDetail"
                                    link-type="anchor" parameter-map="[partyId:orderPartInfo.vendorDetail.partyId]" condition="orderPartInfo.isVendorInternalOrg &amp;&amp; orderPartInfo.vendorDetail"/>
                            <link url="editSupplier" text="PartyNameTemplate" text-map="orderPartInfo.vendorDetail"
                                    link-type="anchor" parameter-map="[partyId:orderPartInfo.vendorDetail.partyId]" condition="!orderPartInfo.isVendorInternalOrg &amp;&amp; orderPartInfo.vendorDetail"/>
                        </container>
                        <label text="Ship Method" type="dt"/>
                        <label text="${orderPartInfo.shipmentMethodEnum?.description ?: ''}" type="dd"/>
                        <label text="Carrier" type="dt" condition="orderPartInfo.carrierPartyDetail"/>
                        <label text="${ec.resource.expand('PartyNameTemplate', null, orderPartInfo.carrierPartyDetail)}" type="dd" condition="orderPartInfo.carrierPartyDetail"/>
                        <label text="Priority" type="dt" style="${orderPartInfo.orderPart.priority == 1 ? 'text-strong text-danger' : (orderPartInfo.orderPart.priority == 2 || orderPartInfo.orderPart.priority == 3 ? 'text-strong text-warning' : '')}"/>
                        <label text="${orderPartInfo.orderPart.priority ?: 5}" type="dd" style="${orderPartInfo.orderPart.priority == 1 ? 'text-strong text-danger' : (orderPartInfo.orderPart.priority == 2 || orderPartInfo.orderPart.priority == 3 ? 'text-strong text-warning' : '')}"/>

                        <label text="Ship After" type="dt" condition="orderPartInfo.orderPart.shipAfterDate"/>
                        <label text="${ec.l10n.format(orderPartInfo.orderPart.shipAfterDate, 'yyyy-MM-dd HH:mm') ?: '\u00a0'}" type="dd"
                                condition="orderPartInfo.orderPart.shipAfterDate"/>
                        <label text="Ship Before" type="dt" condition="orderPartInfo.orderPart.shipBeforeDate"/>
                        <label text="${ec.l10n.format(orderPartInfo.orderPart.shipBeforeDate, 'yyyy-MM-dd HH:mm') ?: '\u00a0'}" type="dd"
                                condition="orderPartInfo.orderPart.shipBeforeDate"/>
                        <label text="Delivery Date" type="dt" condition="orderPartInfo.orderPart.estimatedDeliveryDate"/>
                        <label text="${ec.l10n.format(orderPartInfo.orderPart.estimatedDeliveryDate, 'yyyy-MM-dd HH:mm') ?: '\u00a0'}" type="dd"
                                condition="orderPartInfo.orderPart.estimatedDeliveryDate"/>
                        <label text="Pick Up Date" type="dt" condition="orderPartInfo.orderPart.estimatedPickUpDate"/>
                        <label text="${ec.l10n.format(orderPartInfo.orderPart.estimatedPickUpDate, 'yyyy-MM-dd HH:mm') ?: '\u00a0'}" type="dd"
                                condition="orderPartInfo.orderPart.estimatedPickUpDate"/>

                        <label text="Their Order ID" type="dt"/>
                        <label text="${orderPartInfo.orderPart.otherPartyOrderId ?: '\u00a0'}" type="dd"/>
                        <label text="Their Order Date" type="dt" condition="orderPartInfo.orderPart.otherPartyOrderDate"/>
                        <label text="${ec.l10n.format(orderPartInfo.orderPart.otherPartyOrderDate, 'yyyy-MM-dd HH:mm') ?: '\u00a0'}" type="dd"
                                condition="orderPartInfo.orderPart.otherPartyOrderDate"/>
                        <section name="DuplicatesByOtherPartyOrderIdSection" condition="orderPartInfo.duplicateOrderPartList"><widgets>
                            <label text="Duplicate Order Parts" type="dt" style="text-danger"/>
                            <label text="${orderPartInfo.duplicateOrderPartList.collect({ it.orderId + ':' + it.orderPartSeqId }).join(', ')}" type="dd" style="text-danger"/>
                        </widgets></section>
                        <label text="Shipping Instructions" type="dt"/>
                        <label text="${orderPartInfo.orderPart.shippingInstructions ?: '\u00a0'}" type="dd"/>
                        <label text="Signature Required" type="dt" condition="orderPartInfo.orderPart.signatureRequiredEnumId"/>
                        <label text="${orderPartInfo.orderPart.signatureRequiredEnum?.description}" type="dd" condition="orderPartInfo.orderPart.signatureRequiredEnumId"/>
                        <label text="Is Gift" type="dt"/>
                        <label text="${orderPartInfo.orderPart.isGift ?: 'N'}" type="dd"/>
                        <label text="Gift Message" type="dt"/>
                        <label text="${orderPartInfo.orderPart.giftMessage ?: '\u00a0'}" type="dd"/>

                        <label text="Disable Promotions" type="dt" condition="orderPartInfo.orderPart.disablePromotions == 'Y'"/>
                        <label text="Y" type="dd" condition="orderPartInfo.orderPart.disablePromotions == 'Y'"/>
                        <label text="Disable Tax Calc" type="dt" condition="orderPartInfo.orderPart.disableTaxCalc == 'Y'"/>
                        <label text="Y" type="dd" condition="orderPartInfo.orderPart.disableTaxCalc == 'Y'"/>
                        <label text="Disable Shipping Calc" type="dt" condition="orderPartInfo.orderPart.disableShippingCalc == 'Y'"/>
                        <label text="Y" type="dd" condition="orderPartInfo.orderPart.disableShippingCalc == 'Y'"/>
                        <label text="Auto Reservation" type="dt" condition="orderPartInfo.orderPart.reservationAutoEnumId"/>
                        <label text="${orderPartInfo.orderPart.reservationAutoEnum?.description}" type="dd" condition="orderPartInfo.orderPart.reservationAutoEnumId"/>

                        <label text="Payment Terms" type="dt" condition="orderPartInfo.partSettlementTerm?.description"/>
                        <label text="${orderPartInfo.partSettlementTerm.description}" type="dd" condition="orderPartInfo.partSettlementTerm?.description"/>

                        <label text="Facility " type="dt"/>
                        <container type="dd">
                            <link url="editFacility" text="FacilityNameTemplate" text-map="orderPartInfo.facility"
                                    parameter-map="[facilityId:orderPartInfo.facility.facilityId]" link-type="anchor"
                                    condition="orderPartInfo.facility"/>
                            <text type="html,vuet,qvt" location="component://SimpleScreens/template/party/ContactInfo.html.gstring"/>
                        </container>
                    </container>
                    <section-iterate name="OrderPartRoleSection" list="orderPartInfo.orderPartPartyList" entry="orderPartParty"><widgets>
                        <container>
                            <link url="deleteOrderPartParty" text="X" link-type="hidden-form-link"
                                    parameter-map="[orderId:orderPartParty.orderId, orderPartSeqId:orderPartParty.orderPartSeqId,
                                        partyId:orderPartParty.partyId, roleTypeId:orderPartParty.roleTypeId]"/>
                            <label text="${orderPartParty.description}: " type="strong"/>
                            <label text="PartyNameTemplate" text-map="orderPartParty" type="span"/>
                            <!-- TODO: would be nice to have a general editParty screen to link to from here and elsewhere -->
                        </container>
                    </widgets></section-iterate>
                </row-col>
                <row-col lg="7">
                    <!-- Payment Information -->
                    <section name="PaymentInfoSection"><widgets>
                        <container-box><box-header title="Payment Information"/><box-toolbar>
                            <container-dialog id="AddPaymentInfo" button-text="Add Payment" condition="orderPartInfo.partEditable">
                                <form-single name="AddPaymentForm" transition="addOrderPartPayment" focus-field="paymentMethodId">
                                    <field name="orderId"><default-field><hidden/></default-field></field>
                                    <field name="orderPartSeqId" from="orderPartInfo.orderPart.orderPartSeqId"><default-field><hidden/></default-field></field>

                                    <field name="paymentMethodId"><default-field title="Payment Method"><drop-down allow-empty="true">
                                        <entity-options key="${paymentMethodId}" text="PaymentMethodDetailTemplate">
                                            <entity-find entity-name="mantle.account.method.PaymentMethodDetail">
                                                <date-filter/>
                                                <econditions combine="or">
                                                    <econdition field-name="ownerPartyId" from="customerPartyId"/>
                                                    <econdition field-name="ownerPartyId" from="customerBillToPartyId" ignore-if-empty="true"/>
                                                </econditions>
                                            </entity-find></entity-options>
                                    </drop-down></default-field></field>
                                    <field name="finAccountId"><default-field title="OR Customer Account">
                                        <drop-down allow-empty="true"><entity-options key="${finAccountId}" text="FinancialAccountNameTemplate">
                                            <entity-find entity-name="mantle.account.financial.FinancialAccount">
                                                <econdition field-name="ownerPartyId" from="orderPartInfo.orderPart.customerPartyId"/></entity-find>
                                        </entity-options></drop-down>
                                    </default-field></field>
                                    <field name="paymentInstrumentEnumId"><default-field title="OR Instrument"><drop-down allow-empty="true">
                                        <entity-options key="${enumId}" text="${description}"><entity-find entity-name="moqui.basic.Enumeration">
                                            <econdition field-name="enumTypeId" value="PaymentInstrument"/>
                                            <order-by field-name="description"/>
                                        </entity-find></entity-options>
                                    </drop-down></default-field></field>
                                    <field name="paymentTypeEnumId"><default-field title="Payment Type"><drop-down no-current-selected-key="PtInvoicePayment">
                                        <entity-options key="${enumId}" text="${description}"><entity-find entity-name="moqui.basic.Enumeration">
                                            <econditions combine="or">
                                                <econdition field-name="enumId" value="PtInvoicePayment"/>
                                                <econdition field-name="parentEnumId" value="PtInvoicePayment"/>
                                            </econditions>
                                            <order-by field-name="description"/>
                                        </entity-find></entity-options>
                                    </drop-down></default-field></field>
                                    <field name="dueDate"><default-field><date-time/></default-field></field>
                                    <field name="amount"><default-field><text-line size="10" default-value="${ec.l10n.format(orderPartInfo.partTotalUnpaid ?: 0, '#0.00')}"/></default-field></field>
                                    <field name="settlementTermId" from="orderPartInfo.partSettlementTerm?.orderPmtServiceRegisterId ? orderPartInfo.partSettlementTerm.settlementTermId : null">
                                        <default-field title="Auto Payments Term"><drop-down allow-empty="true">
                                            <entity-options key="${settlementTermId}" text="${description}">
                                                <entity-find entity-name="mantle.account.invoice.SettlementTermAndEnumMember">
                                                    <econdition field-name="enumGroupEnumId" value="EngPaymentTermType"/>
                                                    <econdition field-name="orderPmtServiceRegisterId" operator="is-not-null"/>
                                                    <order-by field-name="description"/>
                                                </entity-find>
                                            </entity-options>
                                        </drop-down></default-field>
                                    </field>
                                    <field name="submitButton"><default-field title="Add"><submit/></default-field></field>
                                </form-single>
                            </container-dialog>
                            <dynamic-dialog id="AddCreditCardDialog" button-text="New Credit Card"
                                    transition="UpdatePaymentMethodInfo" width="800"
                                    parameter-map="[partyId:customerPartyId, paymentMethodTypeEnumId:'PmtCreditCard', orderId:orderId]"/>
                        </box-toolbar><box-body>
                            <label text="OrderDetailPartPaymentIncomplete"
                                    style="text-danger" type="p" condition="orderPartInfo.paymentsTotal &lt; orderPartInfo.orderPart.partTotal"/>
                            <label text="Payments total (${ec.l10n.formatCurrency(orderPartInfo.paymentsTotal ?: 0.0, orderHeader?.currencyUomId)}) is greater than order part total (${ec.l10n.formatCurrency(orderPartInfo.orderPart.partTotal ?: 0.0, orderHeader?.currencyUomId)})"
                                    style="text-warning" type="p" condition="(orderPartInfo.paymentsTotal?:0.0) &gt; (orderPartInfo.orderPart.partTotal?:0.0)"/>
                            <!-- Order Part Existing Payment List -->
                            <section-iterate name="PaymentInfoListSection" list="orderPartInfo.partPaymentInfoList" entry="partPaymentInfo"><actions>
                                <set field="methodInfo" from="partPaymentInfo"/>
                                <entity-find entity-name="mantle.account.method.PaymentGatewayResponse" list="gatewayResponseList">
                                    <econdition field-name="paymentId" from="partPaymentInfo.partPayment.paymentId"/>
                                    <order-by field-name="-transactionDate"/></entity-find>
                            </actions><widgets>
                                <container>
                                    <label text="${partPaymentInfo.paymentMethodTypeEnum?.description?:(partPaymentInfo.paymentInstrumentEnum?.description?:'')} (${partPaymentInfo.paymentTypeEnum?.description}) ${ec.l10n.formatCurrency(partPaymentInfo.partPayment.amount, partPaymentInfo.partPayment.amountUomId)}" type="strong"/>
                                    <label text=" - Status: ${partPaymentInfo.statusItem?.description}" type="strong"/>
                                    <label text=" - Due: ${ec.l10n.format(partPaymentInfo.partPayment.dueDate, 'yyyy-MM-dd')}" type="strong"
                                            condition="partPaymentInfo.partPayment.dueDate"/>
                                    <container-dialog id="UpdatePaymentDialog" button-text="Update"
                                            condition="orderPartInfo.partEditable &amp;&amp; partPaymentInfo.partPayment.statusId in ['PmntProposed', 'PmntPromised']">
                                        <form-single name="UpdatePaymentForm" transition="updatePayment"
                                                map="partPaymentInfo.partPayment" extends="AddPaymentForm">
                                            <field name="orderId"><default-field><hidden/></default-field></field>
                                            <field name="paymentId"><default-field><hidden/></default-field></field>
                                            <field name="amount" from=""><default-field><text-line size="10" format="0.00"/></default-field></field>
                                            <field name="settlementTermId"><default-field><ignored/></default-field></field>
                                            <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                                        </form-single>
                                    </container-dialog>
                                    <container-dialog id="GatewayAuthorizeDialog" button-text="Gateway Authorize" condition="partPaymentInfo.partPayment.statusId in ['PmntPromised', 'PmntProposed', 'PmntDeclined']">
                                        <form-single name="GatewayAuthorizeForm" map="partPaymentInfo.partPayment" transition="gatewayAuthorize">
                                            <field name="orderId"><default-field><hidden/></default-field></field>
                                            <field name="paymentId"><default-field><hidden/></default-field></field>
                                            <field name="cardSecurityCode"><default-field><text-line size="4"/></default-field></field>
                                            <field name="submitButton"><default-field title="Authorize"><submit/></default-field></field>
                                        </form-single>
                                    </container-dialog>
                                    <container-dialog id="GatewayHistoryDialog" button-text="Gateway History" condition="gatewayResponseList" width="900">
                                        <form-list name="GatewayResponseList" skip-form="true"
                                                extends="component://SimpleScreens/screen/SimpleScreens/Accounting/Payment/EditPayment.xml#GatewayResponseList"/>
                                    </container-dialog>
                                    <container>
                                        <link url="editPayment" text="Edit Payment ${partPaymentInfo.partPayment.paymentId}" link-type="anchor"
                                                parameter-map="[paymentId:partPaymentInfo.partPayment.paymentId]"/>
                                        <link url="editPaymentMethod" text="Edit ${partPaymentInfo.paymentMethod?.description ?: 'Payment Method ' + partPaymentInfo.partPayment.paymentMethodId}"
                                                parameter-map="[paymentMethodId:partPaymentInfo.partPayment.paymentMethodId]" link-type="anchor"
                                                condition="partPaymentInfo.partPayment.paymentMethodId != null"/>
                                    </container>

                                    <text type="html,vuet,qvt" location="component://SimpleScreens/template/party/PaymentMethodInfo.html.gstring"/>
                                    <label text="CIM ID: ${methodInfo.paymentMethod.gatewayCimId}" type="div" condition="methodInfo.paymentMethod?.gatewayCimId"/>
                                    <label text="Gateway: ${methodInfo.paymentMethod.gatewayConfig?.description}" type="div" condition="methodInfo.paymentMethod?.paymentGatewayConfigId"/>
                                </container>
                            </widgets></section-iterate>
                        </box-body></container-box>
                    </widgets></section>

                    <!-- Shipping Address, Carrier/Method -->
                    <container-box><box-header title="Shipping Address and Method"/><box-toolbar>
                        <dynamic-dialog id="AddPostalInfo" button-text="Add Shipping Address" transition="UpdateContactInfo"
                                width="800" condition="orderPartInfo.partEditable"
                                parameter-map="[partyId:customerPartyId, postalContactMechPurposeId:'PostalShippingDest',
                                    telecomContactMechPurposeId:'PhoneShippingDest', orderId:orderId, postalContactMechId:null]"/>
                    </box-toolbar><box-body>
                        <section name="CurrentShippingAddress" condition="shippingAddressInfo != null"><actions>
                            <set field="contactInfo" from="shippingAddressInfo"/>
                        </actions><widgets>
                            <container style="row"><container style="col-sm-6">
                                <text type="html,vuet,qvt" location="component://SimpleScreens/template/party/ContactInfo.html.gstring"/>
                            </container><container style="col-sm-6">
                                <dynamic-dialog id="UpdatePostalInfo" button-text="Update Address" transition="UpdateContactInfo"
                                        width="800" condition="orderPartInfo.partEditable"
                                        parameter-map="[partyId:customerPartyId, postalContactMechId:contactInfo.postalContactMechId,
                                                postalContactMechPurposeId:contactInfo.postalContactMechPurposeId, orderId:orderId,
                                                facilityId:contactInfo.facilityId]"/>
                                <container>
                                    <label text="Trust: ${contactInfo.postalTrustLevelEnum?.description ?: 'New'}${contactInfo.postalContactMech.validateMessage?'*':''}"
                                            type="strong" tooltip="${contactInfo.postalContactMech.validateMessage?:''}"/>
                                    <link url="validateAddress" text="Validate"
                                            parameter-map="[orderId:orderId, partyId:customerPartyId, facilityId:contactInfo.facilityId, contactMechId:contactInfo.postalContactMechId]"
                                            condition="!contactInfo.postalContactMech.trustLevelEnumId || contactInfo.postalContactMech.trustLevelEnumId == 'CmtlNew'"/>
                                </container>
                            </container></container>
                        </widgets></section>

                        <label text="No shipping address selected" style="text-danger" type="p"
                                condition="!orderPartInfo.isCustomerInternalOrg &amp;&amp; !orderPart.postalContactMechId"/>
                        <label text="No shipment method selected" style="text-warning" type="p"
                                condition="!orderPartInfo.isCustomerInternalOrg &amp;&amp; !orderPart.shipmentMethodEnumId"/>

                        <container type="hr"/>

                        <form-single name="SetOrderInfoForm" transition="setOrderBillingShippingInfo" map="orderPartInfo.orderPart">
                            <field name="orderId"><default-field><hidden/></default-field></field>
                            <field name="orderPartSeqId"><default-field><hidden/></default-field></field>
                            <field name="paymentMethodId"><default-field><hidden/></default-field></field>
                            <!-- <field name="shippingTelecomContactMechId"><default-field><hidden/></default-field></field> -->

                            <field name="shippingPostalContactMechId" from="orderPart.postalContactMechId">
                                <conditional-field title="Shipping Address" condition="orderPartInfo.partEditable"><drop-down>
                                    <list-options list="shippingPostalAddressList" key="${postalContactMechId}" text="PostalAddressInfoTemplate"/>
                                </drop-down></conditional-field>
                                <default-field><hidden/></default-field>
                            </field>
                            <field name="carrierAndShipmentMethod">
                                <conditional-field title="Shipment Method" condition="orderPartInfo.partEditable">
                                    <drop-down no-current-selected-key="${orderPart.carrierPartyId ? orderPart.carrierPartyId + ':' + orderPart.shipmentMethodEnumId : ''}">
                                        <list-options list="shippingOptions" key="${carrierPartyId}:${shipmentMethodEnumId}"
                                                text="${description ? description : (carrierPartyId != '_NA_' ? (carrierName + ' - ') : '') + shipmentMethodDescription}${shippingTotal != null ? ' ' + ec.l10n.formatCurrency(shippingTotal, orderHeader.currencyUomId) : ''}"/>
                                        <dynamic-options transition="getShippingOptions"/>
                                    </drop-down>
                                </conditional-field>
                                <default-field title="Shipment Method">
                                    <display text="${orderPartInfo.shipmentMethodEnum?.description ?: ''}${orderPartInfo.carrierPartyDetail ? ' - ' + ec.resource.expand('PartyNameTemplate', null, orderPartInfo.carrierPartyDetail) : ''}"/></default-field>
                            </field>
                            <field name="submitButton">
                                <conditional-field condition="orderPartInfo.partEditable" title="Set Shipping Address and Method">
                                    <submit/></conditional-field>
                                <default-field><ignored/></default-field>
                            </field>
                        </form-single>
                    </box-body></container-box>
                </row-col>
            </container-row>

            <section name="AddItemsSection" condition="orderPartInfo.partEditable"><widgets>
                <container-dialog id="AddProductItemContainer" button-text="Add Product Item">
                    <form-single name="AddProductItemForm" transition="addProductItem" focus-field="productId">
                        <field name="orderId"><default-field><hidden/></default-field></field>
                        <field name="orderPartSeqId" from="orderPartInfo.orderPart.orderPartSeqId"><default-field><hidden/></default-field></field>
                        <field name="updateExisting"><default-field><hidden default-value="false"/></default-field></field>
                        <field name="requireInventory"><default-field><hidden default-value="false"/></default-field></field>

                        <field name="assetClassEnumId"><default-field title="Asset Class">
                            <drop-down allow-empty="true" no-current-selected-key="AsClsInventoryFin">
                                <entity-options key="${enumId}" text="${description}"><entity-find entity-name="moqui.basic.Enumeration">
                                    <econdition field-name="parentEnumId" value="AsClsInventory"/><order-by field-name="sequenceNum,description"/>
                                </entity-find></entity-options>
                            </drop-down>
                        </default-field></field>
                        <field name="productId"><default-field title="Product">
                            <drop-down><dynamic-options transition="getProductList" server-search="true" min-length="0" depends-optional="true">
                                <depends-on field="assetClassEnumId"/></dynamic-options></drop-down>
                        </default-field></field>
                        <field name="quantity"><default-field><text-line size="8" default-value="1"/></default-field></field>
                        <field name="unitAmount"><default-field title="Price" tooltip="Leave empty to use Calc Price">
                            <text-line size="10"/></default-field></field>
                        <field name="calcAmount"><default-field title="Calc Price">
                            <display dynamic-transition="getProductPrice"
                                    parameter-map="[orderId:orderId, orderPartSeqId:orderPartInfo.orderPart.orderPartSeqId, priceFormat:'#,##0.00']">
                                <depends-on field="productId"/><depends-on field="quantity"/></display>
                        </default-field></field>
                        <field name="standardCost"><conditional-field condition="orderPartInfo.isCustomerInternalOrg"
                                tooltip="Cost for accounting if different from Price, used to set Asset Acquire Cost on receipt">
                            <text-line size="10"/></conditional-field></field>
                        <field name="requiredByDate" from="orderPartInfo.orderPart.shipBeforeDate"><default-field><date-time format="yyyy-MM-dd HH:mm"/></default-field></field>
                        <!-- <field name="itemDescription"><default-field><text-line size="60"/></default-field></field> -->
                        <field name="itemTypeEnumId" from="null"><conditional-field condition="orderPartInfo.isCustomerInternalOrg" title="Item Type">
                            <drop-down no-current-selected-key="ItemInventory">
                                <option key="ItemInventory" text="Inventory"/>
                                <option key="ItemAsset" text="Fixed Asset"/>
                                <option key="ItemExpSupplies" text="Supplies"/>
                            </drop-down>
                        </conditional-field><default-field title="Item Type">
                            <drop-down no-current-selected-key="ItemProduct">
                                <option key="ItemProduct" text="Product"/>
                                <option key="ItemAsset" text="Fixed Asset"/>
                                <option key="ItemRental" text="Rental Asset"/>
                                <option key="ItemReplacement" text="Replacement"/>
                            </drop-down>
                        </default-field></field>

                        <field name="submitButton"><default-field title="Add"><submit/></default-field></field>
                    </form-single>
                </container-dialog>
                <container-dialog id="AddOtherItemContainer" button-text="Add Other Item">
                    <form-single name="AddOtherItemForm" transition="createItem" focus-field="itemTypeEnumId">
                        <field name="orderId"><default-field><hidden/></default-field></field>
                        <field name="orderPartSeqId" from="orderPartInfo.orderPart.orderPartSeqId"><default-field><hidden/></default-field></field>
                        <field name="requireInventory"><default-field><hidden default-value="false"/></default-field></field>

                        <field name="parentItemSeqId"><default-field title="Parent Item"><drop-down allow-empty="true">
                            <list-options list="applicableParentItems" key="${orderItemSeqId}" text="${orderItemSeqId} - ${itemDescription}"/>
                        </drop-down></default-field></field>
                        <field name="itemTypeEnumId"><default-field title="Item Type">
                            <drop-down no-current-selected-key="ItemShipping">
                                <entity-options key="${enumId}" text="${description}">
                                    <entity-find entity-name="moqui.basic.EnumAndGroup" list="itemTypeEnumList">
                                        <econdition field-name="enumGroupEnumId" from="orderPartInfo.isCustomerInternalOrg ? 'EngItemsPurchase' : 'EngItemsSales'"/>
                                        <order-by field-name="description"/></entity-find></entity-options>
                            </drop-down>
                        </default-field></field>
                        <field name="itemDescription"><default-field title="Description"><text-line size="60"/></default-field></field>
                        <field name="quantity"><default-field><text-line size="8" default-value="1"/></default-field></field>
                        <field name="unitAmount"><default-field title="Price"><text-line size="10"/></default-field></field>
                        <field name="requiredByDate"><default-field><date-time format="yyyy-MM-dd HH:mm"/></default-field></field>

                        <field name="submitButton"><default-field title="Add"><submit/></default-field></field>
                    </form-single>
                </container-dialog>

                <link url="../QuickItems" text="Quick Add Items"/>

                <link url="recalcOrderPartItemAmounts" text="Re-Calc Prices"
                        confirmation="Re-calculate price for each Item and reset to calculated price?"/>

                <link url="updateOrderPart" text="Ship Calc" btn-type="danger" icon="fa fa-remove"
                        condition="orderPart.disableShippingCalc == 'Y'"
                        parameter-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId, disableShippingCalc:'N']"/>
                <link url="updateOrderPart" text="Ship Calc" btn-type="success" icon="fa fa-check"
                        condition="orderPart.disableShippingCalc != 'Y'"
                        parameter-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId, disableShippingCalc:'Y']"/>

                <link url="updateOrderPart" text="Tax Calc" btn-type="danger" icon="fa fa-remove"
                        condition="orderPart.disableTaxCalc == 'Y'"
                        parameter-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId, disableTaxCalc:'N']"/>
                <link url="updateOrderPart" text="Tax Calc" btn-type="success" icon="fa fa-check"
                        condition="orderPart.disableTaxCalc != 'Y'"
                        parameter-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId, disableTaxCalc:'Y']"/>

                <link url="updateOrderPart" text="Promos" btn-type="danger" icon="fa fa-remove"
                        condition="orderPart.disablePromotions == 'Y'"
                        parameter-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId, disablePromotions:'N']"/>
                <link url="updateOrderPart" text="Promos" btn-type="success" icon="fa fa-check"
                        condition="orderPart.disablePromotions != 'Y'"
                        parameter-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId, disablePromotions:'Y']"/>
            </widgets></section>

            <label text="Showing ${orderPartInfo.partNoParentOrderItemList.size()} of ${orderPartInfo.partNoParentOrderItemCount} Items"
                    type="strong" style="text-danger"
                    condition="orderPartInfo.partNoParentOrderItemCount &gt; orderPartInfo.partNoParentOrderItemList.size()"/>
            <link url="../OrderItems" text="All Part Items (${orderPartInfo.partNoParentOrderItemCount})" btn-type="success"
                    condition="orderPartInfo.partNoParentOrderItemCount &gt; orderPartInfo.partNoParentOrderItemList.size()"
                    parameter-map="[orderId:orderId, orderPartSeqId:orderPartInfo.orderPart.orderPartSeqId]"/>

            <form-list name="OrderItems" list="orderPartInfo.partOrderItemList" list-entry="orderItem" transition="updateItem">
                <row-actions>
                    <service-call name="mantle.order.OrderServices.get#OrderItemTotal"
                            in-map="[orderItem:orderItem, getChildrenTotals:true]" out-map="orderItemTotalOut"/>

                    <set field="product" from="orderItem.product"/>
                    <if condition="product != null">
                        <entity-find entity-name="mantle.product.issuance.AssetReservation" list="existingResList">
                            <econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/></entity-find>
                        <set field="resInfoList" from="[]"/>
                        <set field="lotIdSet" from="new LinkedHashSet()"/>
                        <set field="oldestLotExpire" from="null"/>
                        <iterate list="existingResList" entry="existingRes">
                            <entity-find-one entity-name="mantle.product.asset.AssetLotAndMfgParty" value-field="assetLot">
                                <field-map field-name="assetId" from="existingRes.assetId"/>
                                <select-field field-name="productId,lotId,pseudoId,lotNumber,manufacturedDate,expirationDate"/>
                            </entity-find-one>
                            <script><![CDATA[
                            if (assetLot?.lotId) lotIdSet.add(assetLot.lotId)
                            if (assetLot?.expirationDate != null && (oldestLotExpire == null || assetLot.expirationDate < oldestLotExpire))
                                oldestLotExpire = assetLot.expirationDate
                            resInfoList.add([existingRes:existingRes, assetLot:assetLot])
                            ]]></script>
                        </iterate>
                    </if>

                    <!-- returnable quantities and ReturnItems -->
                    <service-call name="mantle.order.ReturnServices.calculate#OrderItemReturnable" out-map="returnableOut"
                                  in-map="[orderId:orderId, orderItemSeqId:orderItem.orderItemSeqId,
                                        orderItemBillingList:orderItemBillingList, returnItemList:returnItemList]"/>
                    <set field="returnIdSet" from="new TreeSet()"/>
                    <iterate list="returnItemList" entry="returnItem">
                        <if condition="returnItem.orderItemSeqId != orderItem.orderItemSeqId"><continue/></if>
                        <script>returnIdSet.add(returnItem.returnId)</script>
                    </iterate>

                    <!-- item quantity and unitAmount EntityAuditLog records -->
                    <set field="itemQuantityAuditList" from="[]"/>
                    <set field="itemUnitAmountAuditList" from="[]"/>
                    <iterate list="allItemsAuditLogList" entry="auditLog">
                        <if condition="auditLog.pkSecondaryValue != orderItem.orderItemSeqId"><continue/></if>
                        <entity-find-one entity-name="mantle.party.PersonWithUserAccount" value-field="userAccount">
                            <field-map field-name="userId" from="auditLog.changedByUserId"/></entity-find-one>
                        <entity-find-one entity-name="moqui.basic.Enumeration" value-field="changeReasonEnum">
                            <field-map field-name="enumId" from="auditLog.changeReason"/></entity-find-one>
                        <if condition="auditLog.changedFieldName == 'quantity'"><then>
                            <script>itemQuantityAuditList.add([auditLog:auditLog, userAccount:userAccount, changeReasonEnum:changeReasonEnum])</script>
                        </then><else>
                            <script>itemUnitAmountAuditList.add([auditLog:auditLog, userAccount:userAccount, changeReasonEnum:changeReasonEnum])</script>
                        </else></if>
                    </iterate>

                    <set field="isProductItemType" from="orderItem.itemTypeEnumId in productItemTypes"/>
                    <set field="isShippable" from="isProductItemType &amp;&amp; product != null ? product.productTypeEnumId in ['PtAsset', 'PtDigitalAsset', 'PtAssetUse', 'PtPickAssembly'] : false"/>
                    <set field="itemQuantityNotShipped" from="quantityNotShippedByItem.get(orderItemSeqId) ?: 0.0"/>
                    <set field="itemQuantityShipped" from="(orderItem.quantity?:0.0) - itemQuantityNotShipped"/>
                    <set field="itemTotalNotBilled" from="totalNotBilledByItem.get(orderItemSeqId) ?: 0.0"/>
                    <set field="itemQuantityNotBilled" from="quantityNotBilledByItem.get(orderItemSeqId) ?: 0.0"/>
                    <set field="itemCanDelete" from="(!isShippable || itemQuantityNotShipped == quantity) &amp;&amp; itemQuantityNotBilled == quantity &amp;&amp; returnableOut.returnedQuantity == 0"/>
                    <!-- <log level="warn" message="itemCanDelete ${itemCanDelete} quantity ${quantity} itemQuantityNotShipped ${itemQuantityNotShipped} itemQuantityNotBilled ${itemQuantityNotBilled} returnableOut.returnedQuantity ${returnableOut.returnedQuantity}"/> -->

                    <set field="newerThanExpireDate" from="null"/>
                    <if condition="orderPartInfo.newerInventory &amp;&amp; orderPartInfo.orderPart.customerPartyId">
                        <!-- get most recent asset issued and lot expire date for it -->
                        <entity-find entity-name="mantle.product.issuance.AssetIssuanceLotSummary" list="issuanceLotList" limit="1">
                            <econdition field-name="toPartyId" from="orderPartInfo.orderPart.customerPartyId"/>
                            <econdition field-name="productId"/>
                            <select-field field-name="expirationDate,expectedEndOfLife"/>
                            <order-by field-name="-issuedDate"/>
                        </entity-find>
                        <if condition="issuanceLotList">
                            <set field="newerThanExpireDate" from="issuanceLotList[0].expirationDate ?: issuanceLotList[0].expectedEndOfLife"/></if>
                    </if>
                </row-actions>

                <hidden-parameters>
                    <parameter name="orderId"/>
                    <parameter name="requireInventory" value="false"/>
                </hidden-parameters>

                <field name="orderItemSeqId"><default-field title="Item" container-style="${parentItemSeqId ? 'text-info' : ''}"><display/></default-field></field>
                <field name="orderPartSeqId" align="center">
                    <conditional-field condition="orderPartInfo.partEditable &amp;&amp; isPromo != 'Y'"><drop-down>
                        <list-options list="orderPartList" key="${orderPartSeqId}" text="${orderPartSeqId}"/></drop-down></conditional-field>
                    <default-field title="Part"><display text="Part ${orderPartSeqId}"/></default-field>
                </field>
                <field name="parentItemSeqId" align="center">
                    <conditional-field condition="isProductItemType || orderItemWithChildrenSet.contains(orderItem.orderItemSeqId)">
                        <display text=" "/></conditional-field>
                    <conditional-field condition="orderPartInfo.partEditable &amp;&amp; isPromo != 'Y'" title="Parent"><drop-down allow-empty="true">
                        <list-options list="applicableParentItems" key="${orderItemSeqId}" text="${orderItemSeqId}"/></drop-down></conditional-field>
                    <default-field title="Parent Item"><display text="${parentItemSeqId ? 'Parent ' + parentItemSeqId : ''}"/></default-field>
                </field>

                <field name="itemTypeEnumId">
                    <!-- <conditional-field condition="orderPartInfo.partEditable" title="Type">
                        <drop-down no-current-selected-key="ItemInventory">
                            <entity-options key="${enumId}" text="${description}"><entity-find entity-name="moqui.basic.Enumeration">
                                <econdition field-name="enumTypeId" value="ItemType"/><order-by field-name="description"/>
                            </entity-find></entity-options></drop-down>
                    </conditional-field> -->
                    <default-field title="Type" container-style="${isProductItemType ? 'text-info' : (itemTypeEnumId == 'ItemDiscount' ? 'text-success' : (itemTypeEnumId in ['ItemSalesTax','ItemVatTax'] ? 'text-warning' : ''))}">
                       <display-entity entity-name="moqui.basic.Enumeration" text="${description}${isPromo ? ' (Promotion)' : ''}"/>
                    </default-field>
                </field>
                <field name="productId">
                    <conditional-field condition="isProductItemType &amp;&amp; orderPartInfo.partEditable">
                        <drop-down><dynamic-options transition="getProductList" server-search="true" min-length="0"/></drop-down>
                    </conditional-field>
                </field>
                <field name="productLink" from="productId"><default-field title="">
                    <link url="editProduct" text="ProductNameTemplate" entity-name="mantle.product.Product" link-type="anchor" condition="productId"/>
                </default-field></field>
                <field name="otherPartyProductId">
                    <conditional-field condition="isProductItemType &amp;&amp; orderPartInfo.partEditable">
                        <text-line size="25"/></conditional-field>
                    <default-field><display/></default-field></field>
                <field name="itemDescription">
                    <conditional-field condition="orderPartInfo.partEditable &amp;&amp; isPromo != 'Y'" title="Description">
                        <text-line size="30"/>
                        <label text="Promo Code: ${promoCodeText}" condition="promoCodeText" type="div"/>
                    </conditional-field>
                    <default-field title="Description">
                        <display/>
                        <label text="Promo Code: ${promoCodeText}" condition="promoCodeText" type="div"/>
                    </default-field></field>
                <field name="comments"><conditional-field condition="orderPartInfo.partEditable &amp;&amp; isPromo != 'Y'">
                    <text-line size="30"/></conditional-field>
                    <default-field><display/></default-field></field>
                <field name="requiredByDate">
                    <conditional-field condition="isProductItemType &amp;&amp; orderPartInfo.partEditable">
                        <date-time/></conditional-field>
                    <default-field><display/></default-field>
                </field>

                <field name="unitListPrice"><default-field title="List Price">
                    <display currency-unit-field="orderHeader.currencyUomId"/></default-field></field>
                <field name="unitAmount">
                    <conditional-field condition="orderPartInfo.partEditable &amp;&amp; isPromo != 'Y'" title="Price">
                        <text-line size="8" format="#,##0.00#"/></conditional-field>
                    <default-field title="Price"><display currency-unit-field="orderHeader.currencyUomId"/></default-field>
                </field>
                <field name="unitAmountHist"><default-field title="">
                    <render-mode><text type="html,vuet"><![CDATA[
                        <#assign popoverContent>
                            <table style="width:100%;"><#list itemUnitAmountAuditList as auditInfo><tr>
                                <td class="text-right">${ec.l10n.formatCurrency(auditInfo.auditLog.newValueText, orderHeader.currencyUomId, 3)}</td>
                                <td class="text-center">${ec.resource.expand('UsernameTemplate', '', auditInfo.userAccount)}</td>
                                <td class="text-center">${ec.l10n.format(auditInfo.auditLog.changedDate, 'yyyy-MM-dd HH:mm')}</td>
                                <td class="text-center">${(auditInfo.changeReasonEnum.description)!(auditInfo.auditLog.changeReason)!''}</td>
                            </tr></#list></table>
                        </#assign>
                        <a role="button" data-toggle="popover" data-placement="left" data-title="${ec.resource.expand('Price History for Item ${orderItemSeqId}', null)}" data-content="${popoverContent?html}">${ec.l10n.localize('Price History')}</a>
                    ]]></text><text type="qvt"><![CDATA[
                        <div class="text-primary cursor-pointer">${ec.l10n.localize('Price History')}<q-tooltip>
                            <div>${ec.resource.expand('Price History for Item ${orderItemSeqId}', null)}</div>
                            <table style="width:100%;"><#list itemUnitAmountAuditList as auditInfo><tr>
                                <td class="text-right">${ec.l10n.formatCurrency(auditInfo.auditLog.newValueText, orderHeader.currencyUomId, 3)}</td>
                                <td class="text-center">${ec.resource.expand('UsernameTemplate', '', auditInfo.userAccount)}</td>
                                <td class="text-center">${ec.l10n.format(auditInfo.auditLog.changedDate, 'yyyy-MM-dd HH:mm')}</td>
                                <td class="text-center">${(auditInfo.changeReasonEnum.description)!(auditInfo.auditLog.changeReason)!''}</td>
                            </tr></#list></table>
                        </q-tooltip></div>
                    ]]></text></render-mode>
                </default-field></field>
                <field name="quantity">
                    <conditional-field condition="orderPartInfo.partEditable &amp;&amp; isPromo != 'Y'"><text-line size="5"/></conditional-field>
                    <default-field><display/></default-field>
                </field>
                <field name="quantity_changeReason">
                    <conditional-field title="Quantity Reason" condition="orderPartInfo.partEditable &amp;&amp; isPromo != 'Y'">
                        <widget-template-include location="component://webroot/template/screen/BasicWidgetTemplates.xml#enumDropDown">
                            <set field="enumTypeId" value="OrderItemQuantityReason"/><set field="allowEmpty" value="true"/></widget-template-include>
                    </conditional-field>
                    <default-field title="Quantity Reason"><ignored/></default-field>
                </field>
                <field name="quantityHist"><default-field title="">
                    <render-mode><text type="html,vuet"><![CDATA[
                        <#assign popoverContent>
                            <table style="width:100%;"><#list itemQuantityAuditList as auditInfo><tr>
                                <td class="text-right">${auditInfo.auditLog.newValueText}</td>
                                <td class="text-center">${ec.resource.expand('UsernameTemplate', '', auditInfo.userAccount)}</td>
                                <td class="text-center">${ec.l10n.format(auditInfo.auditLog.changedDate, 'yyyy-MM-dd HH:mm')}</td>
                                <td class="text-center">${(auditInfo.changeReasonEnum.description)!(auditInfo.auditLog.changeReason)!''}</td>
                            </tr></#list></table>
                        </#assign>
                        <a role="button" data-toggle="popover" data-placement="left" data-title="${ec.resource.expand('Quantity History for Item ${orderItemSeqId}', null)}" data-content="${popoverContent?html}">${ec.l10n.localize('Quantity History')}</a>
                    ]]></text><text type="qvt"><![CDATA[
                        <div class="text-primary cursor-pointer">${ec.l10n.localize('Quantity History')}<q-tooltip>
                            <div>${ec.resource.expand('Quantity History for Item ${orderItemSeqId}', null)}</div>
                            <table style="width:100%;"><#list itemQuantityAuditList as auditInfo><tr>
                                <td class="text-right">${auditInfo.auditLog.newValueText}</td>
                                <td class="text-center">${ec.resource.expand('UsernameTemplate', '', auditInfo.userAccount)}</td>
                                <td class="text-center">${ec.l10n.format(auditInfo.auditLog.changedDate, 'yyyy-MM-dd HH:mm')}</td>
                                <td class="text-center">${(auditInfo.changeReasonEnum.description)!(auditInfo.auditLog.changeReason)!''}</td>
                            </tr></#list></table>
                        </q-tooltip></div>
                    ]]></text></render-mode>
                </default-field></field>
                <field name="standardCost">
                    <conditional-field condition="orderPartInfo.partEditable &amp;&amp; isProductItemType &amp;&amp; orderPartInfo.isCustomerInternalOrg">
                        <text-line size="10" format="#,##0.00#"/></conditional-field>
                    <default-field><display currency-unit-field="orderHeader.currencyUomId"/></default-field>
                </field>

                <field name="notShippedBilled"><default-field title="Not Shipped/Billed">
                    <label text="${ec.l10n.format(itemQuantityNotShipped, '#,##0.###')} / ${ec.l10n.format(itemQuantityNotBilled, '#,##0.###')}"
                            condition="isProductItemType" type="div"/>
                    <label text="N/A / ${ec.l10n.format(itemTotalNotBilled, '#,##0.00')}"
                            condition="!isProductItemType" type="div"/>
                    <label text="Cancelled: ${quantityCancelled}" condition="quantityCancelled" type="p"/>
                </default-field></field>

                <field name="assetReservations">
                    <conditional-field condition="isShippable &amp;&amp; orderPartInfo.isVendorInternalOrg">
                        <section-iterate name="ReservationInfoSection" list="resInfoList" entry="resInfo"><widgets><container>
                            <section name="ComponentProductSection" condition="resInfo.assetLot.productId != orderItem.productId"><actions>
                                <entity-find-one entity-name="mantle.product.Product" value-field="componentProduct" cache="true">
                                    <field-map field-name="productId" from="resInfo.assetLot.productId"/></entity-find-one>
                            </actions><widgets>
                                <container><label text="Component: " type="strong"/>
                                    <link url="editProduct" text="ProductNameTemplate" text-map="componentProduct"
                                            link-type="anchor" parameter-map="[productId:componentProduct.productId]"/>
                                </container>
                            </widgets></section>
                            <link url="assetDetail" text="Asset ${resInfo.existingRes.assetId}" parameter-map="[assetId:resInfo.existingRes.assetId]" link-type="anchor"/>
                            <label text=" - Res: ${ec.l10n.format(resInfo.existingRes.quantity, null)}, Not Avail: ${ec.l10n.format(resInfo.existingRes.quantityNotAvailable, null)}, Not Issued: ${ec.l10n.format(resInfo.existingRes.quantityNotIssued, null)}"
                                    type="span" style="${resInfo.existingRes.quantityNotAvailable ? 'text-danger' : ''}"/>
                            <container>
                                <label text="Lot" type="strong" condition="resInfo.assetLot?.lotId"/>
                                <label text="${ec.resource.expand('LotNameTemplate', '', resInfo.assetLot)}" condition="resInfo.assetLot?.lotId"/>
                            </container>
                        </container></widgets></section-iterate>
                        <label text="Multiple lots ${lotIdSet}" condition="orderPartInfo.singleLot &amp;&amp; lotIdSet.size() &gt; 1"
                                type="div" style="text-danger"/>
                        <label text="Oldest lot ${ec.l10n.format(oldestLotExpire, 'yyyy-MM-dd')} older than last lot expire ${ec.l10n.format(newerThanExpireDate, 'yyyy-MM-dd')}"
                                condition="orderPartInfo.newerInventory &amp;&amp; newerThanExpireDate!=null &amp;&amp; oldestLotExpire!=null &amp;&amp; oldestLotExpire &lt; newerThanExpireDate"
                                type="div" style="text-danger"/>
                        <dynamic-dialog id="ItemReserveDialog" button-text="Reserve Assets" transition="ItemReserve" width="960"
                                condition="orderPartInfo.partEditable || orderPartInfo.orderPart.statusId == 'OrderApproved'"/>
                        <link url="removeOrderItemReservations" text="" btn-type="danger" icon="fa fa-trash" condition="resInfoList"
                                confirmation="Remove inventory reservations for item ${orderItemSeqId}?"/>
                    </conditional-field>
                    <default-field><display text=" "/></default-field>
                </field>

                <field name="itemTotal" from="orderItemTotalOut.itemTotal" align="right"><default-field>
                    <display currency-unit-field="orderHeader.currencyUomId"/></default-field></field>
                <field name="itemPlusChildrenTotal" from="orderItemTotalOut.itemPlusChildrenTotal" align="right">
                    <conditional-field condition="productId"><display currency-unit-field="orderHeader.currencyUomId"/></conditional-field>
                    <default-field title="With Children"><display text=""/></default-field>
                </field>

                <field name="returns"><default-field>
                    <label text="OrderDetailItemBilled" type="div"/>
                    <label text="OrderDetailItemReturned" type="div"/>
                    <section-iterate name="ReturnLinkSection" list="returnIdSet" entry="returnId"><widgets>
                        <link url="editReturn" text="#${returnId}" link-type="anchor"/></widgets></section-iterate>
                    <label text="OrderDetailItemReturnable" type="div"/>
                </default-field></field>
                <field name="returnItem">
                    <conditional-field condition="orderPartInfo.openReturnList &amp;&amp; returnableOut.returnableQuantity &gt; 0">
                        <dynamic-dialog id="ReturnItemCtr" button-text="Return" transition="ReturnItem">
                            <parameter name="orderId"/><parameter name="orderItemSeqId" from="orderItem.orderItemSeqId"/></dynamic-dialog>
                    </conditional-field>
                    <default-field title=""><display text=" "/></default-field>
                </field>

                <field name="submitButton"><conditional-field condition="orderPartInfo.partEditable &amp;&amp; isPromo != 'Y'">
                    <submit text="Update"/>
                    <link url="deleteItem" text="" btn-type="danger" icon="fa fa-trash" condition="itemCanDelete" confirmation="Delete item ${orderItemSeqId}?"/>
                </conditional-field><conditional-field condition="orderPartInfo.partEditable &amp;&amp; isPromo == 'Y'">
                    <link url="deleteItem" text="" btn-type="danger" icon="fa fa-trash" condition="itemCanDelete" confirmation="Delete item ${orderItemSeqId}?"/>
                </conditional-field><default-field title=""/></field>

                <field name="closeButton"><default-field title="">
                    <link url="cancelOrderItem" text="Close" btn-type="warning" link-type="hidden-form"
                            confirmation="Really close item? Quantity will be reduced to quantity shipped and remaining quantity (${ec.l10n.format(itemQuantityNotShipped, null)}) will be cancelled."
                            condition="isProductItemType &amp;&amp; itemQuantityNotShipped &amp;&amp; orderPartInfo.orderPart.statusId in ['OrderOpen', 'OrderPlaced', 'OrderProcessing', 'OrderApproved', 'OrderHold']"
                            parameter-map="[orderItem:null]"/>
                </default-field></field>

                <form-list-column><field-ref name="orderItemSeqId"/><field-ref name="orderPartSeqId"/><field-ref name="parentItemSeqId"/></form-list-column>
                <form-list-column><field-ref name="itemTypeEnumId"/><field-ref name="productId"/><field-ref name="productLink"/>
                    <field-ref name="otherPartyProductId"/></form-list-column>
                <form-list-column><field-ref name="itemDescription"/><field-ref name="comments"/><field-ref name="requiredByDate"/></form-list-column>
                <form-list-column><field-ref name="unitListPrice"/><field-ref name="unitAmount"/><field-ref name="unitAmountHist"/>
                    <field-ref name="quantity"/><field-ref name="quantity_changeReason"/><field-ref name="quantityHist"/></form-list-column>
                <form-list-column><field-ref name="notShippedBilled"/><field-ref name="assetReservations"/><field-ref name="standardCost"/></form-list-column>
                <form-list-column><field-ref name="itemTotal"/><field-ref name="itemPlusChildrenTotal"/></form-list-column>
                <form-list-column><field-ref name="returns"/><field-ref name="returnItem"/></form-list-column>
                <form-list-column><field-ref name="submitButton"/><field-ref name="closeButton"/></form-list-column>
            </form-list>
        </widgets></section-iterate>
        <text type="html,vuet"><![CDATA[<script>$(function () { $('[data-toggle="popover"]').popover({ sanitize:false, html:true, trigger:"hover click" }); })</script>]]></text>
    </widgets>
</screen>
